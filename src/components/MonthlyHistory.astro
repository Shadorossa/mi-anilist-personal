---
const { works = [], chars = [] } = Astro.props;
---

<div class="w-full" id="monthly-history-component">
    <div class="flex gap-6 items-center">
        <div class="flex-1 min-w-0">
            <!-- Works History -->
            <div id="hist-works-wrapper" class="relative group/carousel">
                <div class="fade-x">
                    <div
                        id="hist-works-scroll"
                        class="hide-scroll overflow-x-auto scroll-smooth"
                    >
                        <div
                            class="grid grid-flow-col grid-rows-2 auto-cols-[180px] sm:auto-cols-[200px] gap-3 animate-fade-in"
                        >
                            {
                                works.map((pick) => (
                                    <div class="bg-[#121215] border border-white/5 rounded-lg p-2 group hover:bg-white/5 hover:border-white/10 transition-all duration-300 cursor-default h-full flex flex-col">
                                        <div class="flex gap-2 h-10 mb-2 shrink-0">
                                            <div class="w-10 bg-[#0a0a0c] rounded border border-white/5 flex flex-col items-center justify-center shrink-0">
                                                <span class="text-[8px] text-gray-500 font-bold leading-none mb-0.5">
                                                    {pick.year}
                                                </span>
                                                <span class="text-[9px] text-indigo-400 font-black leading-none tracking-wide">
                                                    {pick.month}
                                                </span>
                                            </div>
                                            <div class="flex-1 relative rounded overflow-hidden shadow-sm">
                                                <img
                                                    src={pick.cover}
                                                    class="absolute inset-0 w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
                                                    loading="lazy"
                                                    style={`object-position: center ${pick.coverOffsetY !== undefined ? pick.coverOffsetY : 50}%`}
                                                />
                                            </div>
                                        </div>

                                        <div class="flex-1 flex items-center justify-center px-0.5 min-h-[24px]">
                                            <h4 class="text-[10px] font-bold text-gray-400 leading-tight text-center group-hover:text-white transition-colors line-clamp-2">
                                                {pick.title}
                                            </h4>
                                        </div>
                                    </div>
                                ))
                            }
                        </div>
                    </div>
                </div>
                {
                    works.length > 6 && (
                        <>
                            <button
                                onclick="scrollHistoryGrid('hist-works-scroll', -1)"
                                class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-full z-10 w-8 h-8 rounded-full text-gray-600 opacity-0 group-hover/carousel:opacity-100 transition-all flex items-center justify-center hover:bg-white/10 hover:text-white"
                            >
                                <i class="fa-solid fa-chevron-left" />
                            </button>
                            <button
                                onclick="scrollHistoryGrid('hist-works-scroll', 1)"
                                class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-full z-10 w-8 h-8 rounded-full text-gray-600 opacity-0 group-hover/carousel:opacity-100 transition-all flex items-center justify-center hover:bg-white/10 hover:text-white"
                            >
                                <i class="fa-solid fa-chevron-right" />
                            </button>
                        </>
                    )
                }
                {
                    works.length === 0 && (
                        <div class="h-[150px] flex items-center justify-center text-center text-xs text-gray-600 italic">
                            No hay obras registradas.
                        </div>
                    )
                }
            </div>

            <!-- Chars History -->
            <div id="hist-chars-wrapper" class="hidden relative group/carousel">
                <div class="fade-x">
                    <div
                        id="hist-chars-scroll"
                        class="hide-scroll overflow-x-auto scroll-smooth"
                    >
                        <div
                            class="grid grid-flow-col grid-rows-2 auto-cols-[180px] sm:auto-cols-[200px] gap-3 animate-fade-in"
                        >
                            {
                                chars.map((pick) => (
                                    <div class="bg-[#121215] border border-white/5 rounded-lg p-2 group hover:bg-white/5 hover:border-white/10 transition-all duration-300 cursor-default h-full flex flex-col">
                                        <div class="flex gap-2 h-10 mb-2 shrink-0">
                                            <div class="w-10 bg-[#0a0a0c] rounded border border-white/5 flex flex-col items-center justify-center shrink-0">
                                                <span class="text-[8px] text-gray-500 font-bold leading-none mb-0.5">
                                                    {pick.year}
                                                </span>
                                                <span class="text-[9px] text-pink-400 font-black leading-none tracking-wide">
                                                    {pick.month}
                                                </span>
                                            </div>
                                            <div class="flex-1 relative rounded overflow-hidden shadow-sm">
                                                <img
                                                    src={pick.cover}
                                                    class="absolute inset-0 w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
                                                    loading="lazy"
                                                    style={`object-position: center ${pick.coverOffsetY !== undefined ? pick.coverOffsetY : 50}%`}
                                                />
                                            </div>
                                        </div>

                                        <div class="flex-1 flex items-center justify-center px-0.5 min-h-[24px]">
                                            <h4 class="text-[10px] font-bold text-gray-400 leading-tight text-center group-hover:text-white transition-colors line-clamp-2">
                                                {pick.title}
                                            </h4>
                                        </div>
                                    </div>
                                ))
                            }
                        </div>
                    </div>
                </div>
                {
                    chars.length > 6 && (
                        <>
                            <button
                                onclick="scrollHistoryGrid('hist-chars-scroll', -1)"
                                class="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-full z-10 w-8 h-8 rounded-full text-gray-600 opacity-0 group-hover/carousel:opacity-100 transition-all flex items-center justify-center hover:bg-white/10 hover:text-white"
                            >
                                <i class="fa-solid fa-chevron-left" />
                            </button>
                            <button
                                onclick="scrollHistoryGrid('hist-chars-scroll', 1)"
                                class="absolute right-0 top-1/2 -translate-y-1/2 translate-x-full z-10 w-8 h-8 rounded-full text-gray-600 opacity-0 group-hover/carousel:opacity-100 transition-all flex items-center justify-center hover:bg-white/10 hover:text-white"
                            >
                                <i class="fa-solid fa-chevron-right" />
                            </button>
                        </>
                    )
                }
                {
                    chars.length === 0 && (
                        <div class="h-[150px] flex items-center justify-center text-center text-xs text-gray-600 italic">
                            No hay personajes registrados.
                        </div>
                    )
                }
            </div>
        </div>
        <div class="flex flex-col items-center gap-2">
            <button
                onclick="switchHistory('works')"
                id="btn-hist-works"
                class="w-10 h-10 flex items-center justify-center rounded-lg transition-colors bg-white/10 text-white"
            >
                <i class="fa-solid fa-gamepad"></i>
            </button>
            <div class="w-px h-4 bg-white/10"></div>
            <button
                onclick="switchHistory('chars')"
                id="btn-hist-chars"
                class="w-10 h-10 flex items-center justify-center rounded-lg transition-colors text-gray-600 hover:bg-white/5 hover:text-white"
            >
                <i class="fa-solid fa-mask"></i>
            </button>
        </div>
    </div>
</div>

<script is:inline>
    window.switchHistory = (type) => {
        const wContainer = document.getElementById("hist-works-wrapper");
        const cContainer = document.getElementById("hist-chars-wrapper");
        const btnW = document.getElementById("btn-hist-works");
        const btnC = document.getElementById("btn-hist-chars");

        if (type === "works") {
            wContainer.classList.remove("hidden");
            cContainer.classList.add("hidden");

            btnW.className =
                "w-10 h-10 flex items-center justify-center rounded-lg transition-colors bg-white/10 text-white";
            btnC.className =
                "w-10 h-10 flex items-center justify-center rounded-lg transition-colors text-gray-600 hover:bg-white/5 hover:text-white";
        } else {
            wContainer.classList.add("hidden");
            cContainer.classList.remove("hidden");

            btnC.className =
                "w-10 h-10 flex items-center justify-center rounded-lg transition-colors bg-white/10 text-white";
            btnW.className =
                "w-10 h-10 flex items-center justify-center rounded-lg transition-colors text-gray-600 hover:bg-white/5 hover:text-white";
        }
    };

    function setupDraggableCarousel(carouselId) {
        const slider = document.getElementById(carouselId);
        if (!slider || slider.dataset.draggable) return;
        slider.dataset.draggable = true;
        slider.style.cursor = "grab";

        let isDown = false;
        let startX;
        let scrollLeft;

        const startDragging = (e) => {
            e.preventDefault();
            isDown = true;
            slider.classList.add("active-drag");
            startX = e.pageX - slider.offsetLeft;
            scrollLeft = slider.scrollLeft;
            document.addEventListener("mousemove", onDragging);
            document.addEventListener("mouseup", stopDragging);
        };

        const onDragging = (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - slider.offsetLeft;
            const walk = x - startX; // No multiplier for max smoothness
            slider.scrollLeft = scrollLeft - walk;
        };

        const stopDragging = () => {
            isDown = false;
            slider.classList.remove("active-drag");
            document.removeEventListener("mousemove", onDragging);
            document.removeEventListener("mouseup", stopDragging);
        };

        slider.addEventListener("mousedown", startDragging);
    }

    setupDraggableCarousel("hist-works-scroll");
    setupDraggableCarousel("hist-chars-scroll");

    document.addEventListener("keydown", (e) => {
        const historyComponent = document.getElementById(
            "monthly-history-component",
        );
        if (!historyComponent?.matches(":hover")) {
            return;
        }

        const worksWrapper = document.getElementById("hist-works-wrapper");
        let activeSlider = null;

        if (worksWrapper && !worksWrapper.classList.contains("hidden")) {
            activeSlider = document.getElementById("hist-works-scroll");
        } else {
            activeSlider = document.getElementById("hist-chars-scroll");
        }

        if (activeSlider && (e.key === "ArrowLeft" || e.key === "ArrowRight")) {
            const rect = activeSlider.getBoundingClientRect();
            const isInViewport =
                rect.top < window.innerHeight && rect.bottom >= 0;
            if (isInViewport) {
                activeSlider.scrollBy({
                    left: e.key === "ArrowLeft" ? -300 : 300,
                    behavior: "smooth",
                });
            }
        }
    });

    window.scrollHistoryGrid = (elementId, direction) => {
        const container = document.getElementById(elementId);
        if (container) {
            const scrollAmount = container.clientWidth * 0.8; // Scroll 80% of the visible width
            container.scrollBy({
                left: scrollAmount * direction,
                behavior: "smooth",
            });
        }
    };
</script>

<style>
    .fade-x {
        -webkit-mask-image: linear-gradient(
            to right,
            transparent,
            black 20px,
            black calc(100% - 20px),
            transparent
        );
        mask-image: linear-gradient(
            to right,
            transparent,
            black 20px,
            black calc(100% - 20px),
            transparent
        );
    }
    .hide-scroll::-webkit-scrollbar {
        display: none;
    }
    .hide-scroll {
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
    }
    .active-drag {
        cursor: grabbing !important;
        scroll-behavior: auto;
        user-select: none;
    }
    .animate-fade-in {
        animation: fadeIn 0.4s ease-out forwards;
    }
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
