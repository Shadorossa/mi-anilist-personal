---
const { data = [] } = Astro.props;
---

<div
    id="time-travel-container"
    class="w-full bg-[#0a0a0c] border border-white/5 rounded-2xl p-6 relative h-[300px] overflow-hidden"
>
    <div
        id="time-travel-scroll"
        class="w-full h-full overflow-x-auto overflow-y-hidden custom-scrollbar relative"
    >
        <div id="time-travel-timeline" class="relative h-full pl-6">
            <!-- Year markers will be generated by script -->
            <div
                id="time-travel-year-markers"
                class="absolute top-0 left-0 h-full w-full flex pointer-events-none"
            >
            </div>
            <!-- Items will be generated by script -->
        </div>
    </div>
    <div
        class="absolute top-4 right-6 text-xs text-gray-500 font-bold flex items-center gap-2"
    >
        <i class="fa-solid fa-arrows-left-right"></i>
        <span>Desliza para explorar</span>
    </div>
</div>

<script define:vars={{ works: data }}>
    function initializeTimeline(works) {
        const timeline = document.getElementById("time-travel-timeline");
        const slider = document.getElementById("time-travel-scroll");
        const yearMarkersContainer = document.getElementById(
            "time-travel-year-markers",
        );
        if (!timeline || !yearMarkersContainer || works.length === 0) {
            timeline.innerHTML = `<div class="w-full h-full flex items-center justify-center text-gray-600">No hay datos de duración para mostrar.</div>`;
            return;
        }

        const items = parseAndFilterItems(works);
        if (items.length === 0) {
            timeline.innerHTML = `<div class="w-full h-full flex items-center justify-center text-gray-600">No hay datos de duración para mostrar.</div>`;
            return;
        }

        const { minDate, maxDate, totalYears, totalDurationMs } = calculateDateRange(items);
        const timelineWidth = calculateTimelineWidth(totalYears);
        timeline.style.width = `${timelineWidth}px`;

        renderMarkers(yearMarkersContainer, minDate, maxDate, totalDurationMs, timelineWidth);
        renderItemBars(timeline, items, minDate, totalDurationMs, timelineWidth);
        setupDraggableScroll(slider);
    }

    function parseAndFilterItems(works) {
        const items = works
            .map((w) => ({
                ...w,
                startDate: new Date(w.startDate),
                finishDate: new Date(w.finishDate),
            }))
            .filter(
                (w) =>
                    !isNaN(w.startDate) &&
                    !isNaN(w.finishDate) &&
                    w.finishDate > w.startDate,
            );
        return items;
    }

    function calculateDateRange(items) {
        const minDate = new Date(Math.min(...items.map((w) => w.startDate)));
        const maxDate = new Date(Math.max(...items.map((w) => w.finishDate)));
        const startYear = minDate.getFullYear();
        const endYear = maxDate.getFullYear();
        const totalYears = endYear - startYear + 1;
        const totalDurationMs = maxDate.getTime() - minDate.getTime();
        return { minDate, maxDate, startYear, endYear, totalYears, totalDurationMs };
    }

    function calculateTimelineWidth(totalYears) {
        return totalYears * 2800; // "Zoom" horizontal
    }

    function renderMarkers(container, minDate, maxDate, totalDurationMs, timelineWidth) {
        let markersHTML = "";
        const pixelsPerDay =
            timelineWidth / (totalDurationMs / (1000 * 60 * 60 * 24));
        const showMonths = pixelsPerDay * 30 > 40; // Show month ticks if a month is wider than 40px
        const monthNames = [
            "Ene",
            "Feb",
            "Mar",
            "Abr",
            "May",
            "Jun",
            "Jul",
            "Ago",
            "Sep",
            "Oct",
            "Nov",
            "Dic",
        ];
        const startYear = minDate.getFullYear();
        const endYear = maxDate.getFullYear();

        for (let year = startYear; year <= endYear; year++) {
            const yearStartDate = new Date(year, 0, 1);
            const leftPercentage =
                ((yearStartDate.getTime() - minDate.getTime()) /
                    totalDurationMs) *
                100;

            if (leftPercentage >= 0 && leftPercentage <= 100) {
                markersHTML += `
                    <div class="absolute top-0 h-full" style="left: ${leftPercentage}%">
                        <div class="w-px h-full bg-white/5"></div>
                        <span class="absolute top-4 left-2 text-2xl font-black text-white/10">${year}</span>
                    </div>
                `;
            }

            if (showMonths) {
                for (let month = 1; month < 12; month++) {
                    // Empezar en 1 (Feb) para no solapar con el año
                    const monthStartDate = new Date(year, month, 1);
                    if (monthStartDate < minDate || monthStartDate > maxDate)
                        continue;

                    const monthLeftPercentage =
                        ((monthStartDate.getTime() - minDate.getTime()) /
                            totalDurationMs) *
                        100;

                    markersHTML += `
                        <div class="absolute top-16 h-[calc(100%-4rem)]" style="left: ${monthLeftPercentage}%">
                            <div class="w-px h-full bg-white/10 opacity-30"></div>
                            <span class="absolute -top-5 -translate-x-1/2 text-[10px] font-bold text-gray-600">${monthNames[month]}</span>
                        </div>
                    `;
                }
            }
        }
        container.innerHTML = markersHTML;
    }

    function renderItemBars(timeline, items, minDate, totalDurationMs, timelineWidth) {
        let itemsHTML = "";
        const lanes = [];

        const colorPalette = [
            "#f87171", // red-400
            "#fb923c", // orange-400
            "#a3e635", // lime-400
            "#34d399", // emerald-400
            "#22d3ee", // cyan-400
            "#60a5fa", // blue-400
            "#c084fc", // purple-400
            "#f472b6", // pink-400
        ];

        function getColorFromTitle(title) {
            let hash = 0;
            for (let i = 0; i < title.length; i++) {
                hash = title.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash % colorPalette.length);
            return colorPalette[index];
        }

        const LANE_HEIGHT = 24;
        const BAR_AREA_HEIGHT = 20;

        items.forEach((item) => {
            const leftPercentage =
                ((item.startDate.getTime() - minDate.getTime()) /
                    totalDurationMs) *
                100;
            const widthPercentage =
                ((item.finishDate.getTime() - item.startDate.getTime()) /
                    totalDurationMs) *
                100;

            let placed = false;
            for (let i = 0; i < lanes.length; i++) {
                if (lanes[i] < item.startDate.getTime()) {
                    lanes[i] = item.finishDate.getTime();
                    item.lane = i;
                    placed = true;
                    break;
                }
            }
            if (!placed) {
                item.lane = lanes.length;
                lanes.push(item.finishDate.getTime());
            }

            const top = item.lane * LANE_HEIGHT + 70;
            const durationDays = Math.round(
                (item.finishDate - item.startDate) / (1000 * 60 * 60 * 24),
            );
            const leftPx = (leftPercentage / 100) * timelineWidth;
            const widthPx = Math.max(
                (widthPercentage / 100) * timelineWidth,
                2,
            ); // Min width of 2px
            const itemColor = getColorFromTitle(item.title);

            itemsHTML += `
                <div 
                    class="absolute group" 
                    style="top: ${top}px; left: ${leftPx}px; width: ${widthPx}px; height: ${BAR_AREA_HEIGHT}px; --item-color: ${itemColor};"
                >
                    <!-- The visible duration bar -->
                    <div class="w-full h-2 bg-[var(--item-color)] opacity-60 rounded-full group-hover:opacity-100 transition-opacity cursor-pointer absolute top-1/2 -translate-y-1/2"></div>
    
                    <!-- Cover image at the start of the line -->
                    <div class="absolute top-1/2 -translate-y-1/2 -left-3.5 w-7 h-7 rounded-full bg-zinc-800 border-2 border-[#0a0a0c] shadow-md overflow-hidden z-10 group-hover:scale-110 group-hover:border-[var(--item-color)] transition-all">
                        <img src="${item.cover}" loading="lazy" class="w-full h-full object-cover" style="object-position: center ${item.coverOffsetY ?? 50}%" />
                    </div>

                    <!-- The popover/tooltip that appears on hover -->
                    <div class="absolute bottom-full mb-4 left-0 w-max max-w-[250px] p-2 bg-[#18181b] border border-white/10 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-all duration-300 pointer-events-none z-20 transform group-hover:scale-100 scale-95 -translate-x-1/2">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-[60px] rounded-md overflow-hidden shrink-0 bg-zinc-800">
                                <img src="${item.cover}" loading="lazy" class="w-full h-full object-cover" style="object-position: center ${item.coverOffsetY ?? 50}%" />
                            </div>
                            <div class="py-1">
                                <p class="text-white text-xs font-bold leading-tight">${item.title}</p>
                                <p class="text-gray-500 text-[10px] mt-1">${durationDays} día${durationDays !== 1 ? "s" : ""}</p>
                            </div>
                        </div>
                        <!-- Arrow -->
                        <div class="absolute left-4 -bottom-1 w-2 h-2 bg-[#18181b] border-r border-b border-white/10 transform rotate-45"></div>
                    </div>
                </div>
            `;
        });
        timeline.insertAdjacentHTML('beforeend', itemsHTML);
    }

    function setupDraggableScroll(slider) {
        if (!slider) return;
        slider.style.cursor = "grab";

        let isDown = false;
        let startX;
        let scrollLeft;

        slider.addEventListener("mousedown", (e) => {
            isDown = true;
            slider.style.cursor = "grabbing";
            slider.classList.add("active-drag");
            startX = e.pageX - slider.offsetLeft;
            scrollLeft = slider.scrollLeft;
        });

        slider.addEventListener("mouseleave", () => {
            isDown = false;
            slider.style.cursor = "grab";
            slider.classList.remove("active-drag");
        });

        slider.addEventListener("mouseup", () => {
            isDown = false;
            slider.style.cursor = "grab";
            slider.classList.remove("active-drag");
        });

        slider.addEventListener("mousemove", (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - slider.offsetLeft;
            const walk = (x - startX) * 2; // Multiplier for faster scrolling
            slider.scrollLeft = scrollLeft - walk;
        });
    }

    document.addEventListener("DOMContentLoaded", () => initializeTimeline(works));
</script>

<style>
    #time-travel-scroll.custom-scrollbar::-webkit-scrollbar {
        height: 8px;
    }
    #time-travel-scroll.custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
    }
    #time-travel-scroll.custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
    }
    #time-travel-scroll.custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    #time-travel-scroll.active-drag {
        scroll-behavior: auto;
        user-select: none;
    }
</style>
