---
const { sagas = {}, allContent } = Astro.props;
const calculateRating = (score) => (score / 2).toFixed(score % 2 === 0 ? 0 : 1);
---

<div class="w-full flex flex-col" id="library-section">
    <div
        class="flex flex-col xl:flex-row gap-4 mb-8 bg-[#121215] p-2 rounded-xl border border-white/5 items-center justify-between shadow-lg"
    >
        <div
            class="flex gap-1 w-full xl:w-auto justify-center xl:justify-start"
        >
            <button
                onclick="filterType('all', this)"
                class="type-btn active px-3 py-1.5 rounded-lg text-[10px] uppercase font-bold transition-all"
                >Todos</button
            >
            <button
                onclick="filterType('game', this)"
                class="type-btn px-3 py-1.5 rounded-lg text-[10px] uppercase font-bold text-gray-500 hover:bg-white/5 transition-all"
                >Juegos</button
            >
            <button
                onclick="filterType('anime', this)"
                class="type-btn px-3 py-1.5 rounded-lg text-[10px] uppercase font-bold text-gray-500 hover:bg-white/5 transition-all"
                >Anime</button
            >
            <button
                onclick="filterType('manga', this)"
                class="type-btn px-3 py-1.5 rounded-lg text-[10px] uppercase font-bold text-gray-500 hover:bg-white/5 transition-all"
                >Manga</button
            >
        </div>

        <div
            class="flex flex-col sm:flex-row items-center gap-4 w-full xl:w-auto justify-center xl:justify-end"
        >
            <div class="flex gap-1">
                <input
                    type="text"
                    id="library-text-filter"
                    placeholder="Buscar en biblioteca..."
                    class="bg-[#0a0a0c] border border-white/5 rounded-lg px-3 py-1.5 text-xs text-white outline-none focus:border-white/10 w-full sm:w-48 transition-colors"
                />
                <div class="h-6 w-px bg-white/10 hidden sm:block"></div>

                <div class="flex gap-1">
                    <button
                        onclick="filterStatus('all', this)"
                        class="status-btn active w-8 h-8 flex items-center justify-center rounded-lg text-white bg-white/10 shadow-sm transition-all"
                        title="Todo"
                        ><i class="fa-solid fa-border-all text-xs"></i></button
                    >
                    <button
                        onclick="filterStatus('Completado', this)"
                        class="status-btn w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 hover:text-blue-400 hover:bg-white/5 transition-all"
                        title="Terminado"
                        ><i class="fa-solid fa-check-double text-xs"
                        ></i></button
                    >
                    <button
                        onclick="filterStatus('Jugando', this)"
                        class="status-btn w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 hover:text-green-400 hover:bg-white/5 transition-all"
                        title="Activo"
                        ><i class="fa-solid fa-gamepad text-xs"></i></button
                    >
                    <button
                        onclick="filterStatus('Pendiente', this)"
                        class="status-btn w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 hover:text-yellow-400 hover:bg-white/5 transition-all"
                        title="Pendiente"
                        ><i class="fa-regular fa-clock text-xs"></i></button
                    >
                    <button
                        onclick="filterStatus('Abandonado', this)"
                        class="status-btn w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 hover:text-red-400 hover:bg-white/5 transition-all"
                        title="Droppeado"
                        ><i class="fa-solid fa-ban text-xs"></i></button
                    >
                </div>

                <div class="h-6 w-px bg-white/10 hidden sm:block"></div>

                <button
                    onclick="setSort('saga', this)"
                    class="sort-btn active w-8 h-8 flex items-center justify-center rounded-lg bg-white/5 text-white transition-all"
                    title="Por Saga"
                    ><i class="fa-solid fa-list-ol text-xs"></i></button
                >
                <button
                    onclick="setSort('score', this)"
                    class="sort-btn w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 hover:text-yellow-400 hover:bg-white/5 transition-all"
                    title="Por Nota"
                    ><i class="fa-solid fa-star text-xs"></i></button
                >
                <button
                    onclick="setSort('year', this)"
                    class="sort-btn w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 hover:text-blue-400 hover:bg-white/5 transition-all"
                    title="Por Fecha de Completado"
                    ><i class="fa-regular fa-calendar text-xs"></i></button
                >
                <button
                    onclick="setSort('title', this)"
                    class="sort-btn w-8 h-8 flex items-center justify-center rounded-lg text-gray-500 hover:text-white hover:bg-white/5 transition-all"
                    title="Alfabéticamente"
                    ><i class="fa-solid fa-font text-xs"></i></button
                >
                <button
                    id="orderBtn"
                    onclick="toggleOrder()"
                    class="ml-2 w-8 h-8 flex items-center justify-center rounded-lg bg-white/5 hover:bg-white/10 text-gray-300 transition-all border border-white/5"
                    style="display: none;"
                    ><i class="fa-solid fa-arrow-down-wide-short text-xs"
                    ></i></button
                >
            </div>
        </div>
    </div>

    <div
        id="library-grid"
        class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-7 gap-4 md:gap-6 min-h-[400px]"
    >
        <!-- Populated by script -->
    </div>

    <div
        id="library-load-more-container"
        class="w-full flex justify-center mt-8"
    >
        <button
            id="load-more-btn"
            class="hidden bg-white/5 hover:bg-white/10 text-gray-300 font-bold text-xs uppercase tracking-wider px-6 py-2 rounded-lg transition"
        >
            Cargar más
        </button>
    </div>

    <div
        id="library-empty"
        class="hidden flex-col items-center justify-center py-20 text-gray-600"
    >
        <div
            class="w-20 h-20 bg-[#121215] rounded-full flex items-center justify-center mb-4 border border-white/5"
        >
            <i class="fa-solid fa-box-open text-3xl opacity-30"></i>
        </div>
        <p class="font-medium text-sm">No hay coincidencias.</p>
    </div>
</div>

<script is:inline define:vars={{ sagas, allContent }}>
    const INITIAL_LOAD = 42;
    const LOAD_MORE_COUNT = 21;

    window.localLibrary = allContent;
    let currentlyVisibleCount = INITIAL_LOAD;

    let currentStatus = "all";
    let currentType = "all";
    let currentSort = "saga";
    let isAscending = false;

    const emptyEl = document.getElementById("library-empty");
    const gridEl = document.getElementById("library-grid");
    const textFilterInput = document.getElementById("library-text-filter");
    const loadMoreBtn = document.getElementById("load-more-btn");

    const statusWeight = {
        Completado: 1,
        Jugando: 2,
        Viendo: 2,
        Leyendo: 2,
        Pausado: 2,
        Pendiente: 3,
        Abandonado: 4,
    };

    // Create a map for fast saga lookup
    const sagaOrderMap = new Map();
    let sagaIndex = 0;
    for (const sagaName in sagas) {
        if (Object.prototype.hasOwnProperty.call(sagas, sagaName)) {
            sagas[sagaName].forEach((title, gameIndex) => {
                sagaOrderMap.set(title, { sagaName, sagaIndex, gameIndex });
            });
            sagaIndex++;
        }
    }

    const calculateRating = (score) =>
        (score / 2).toFixed(score % 2 === 0 ? 0 : 1);

    function renderItemCard(item) {
        const rating = calculateRating(item.score);
        const statusClass =
            item.status === "Jugando" ||
            item.status === "Viendo" ||
            item.status === "Leyendo"
                ? "bg-green-500 shadow-green-500"
                : item.status === "Completado"
                  ? "bg-blue-500 shadow-blue-500"
                  : item.status === "Pendiente"
                    ? "bg-yellow-500 shadow-yellow-500"
                    : "bg-red-500 shadow-red-500";

        return `
            <div class="lib-item relative aspect-[2/3] rounded-xl overflow-hidden cursor-pointer group bg-[#18181b] ring-1 ring-white/5 shadow-sm hover:shadow-2xl hover:shadow-[var(--accent-color)]/10 transition-all duration-300 hover:-translate-y-1" style="animation: fadeInUp 0.3s ease-out forwards;">
                <img src="${item.cover}" loading="lazy" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 opacity-70 group-hover:opacity-100" />
                <div class="absolute top-3 right-3 z-10" title="${item.status}">
                    <div class="w-2 h-2 rounded-full shadow-[0_0_8px] ring-1 ring-black/50 ${statusClass}"></div>
                </div>
                <div class="absolute inset-0 bg-gradient-to-t from-black/95 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4">
                    <div class="w-full">
                        <h3 class="text-white text-xs font-bold leading-tight line-clamp-2 mb-2">${item.title}</h3>
                        <div class="flex items-center justify-between border-t border-white/10 pt-2">
                            <span class="text-[10px] text-gray-400 font-bold"><i class="fa-regular fa-calendar mr-1"></i> ${item.year}</span>
                            ${item.status === "Completado" && item.score > 0 ? `<span class="text-[10px] text-yellow-500 font-bold bg-yellow-500/10 px-1.5 py-0.5 rounded"><i class="fa-solid fa-star mr-1"></i> ${rating}</span>` : ""}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function updateGrid() {
        const textFilter = textFilterInput.value.toLowerCase();
        const filteredItems = window.localLibrary.filter((item) => {
            const s = item.status;
            const statusMatch =
                currentStatus === "all" ||
                s === currentStatus ||
                (currentStatus === "Jugando" &&
                    (s === "Viendo" || s === "Leyendo"));
            const typeMatch =
                currentType === "all" || item.type === currentType;
            const titleMatch = item.title.toLowerCase().includes(textFilter);
            return statusMatch && typeMatch && titleMatch;
        });

        filteredItems.sort((a, b) => {
            if (currentSort === "saga") {
                const sagaA = sagaOrderMap.get(a.title);
                const sagaB = sagaOrderMap.get(b.title);

                const sortKeyA = sagaA ? sagaA.sagaName : a.title;
                const sortKeyB = sagaB ? sagaB.sagaName : b.title;

                if (sortKeyA !== sortKeyB) {
                    return sortKeyA.localeCompare(sortKeyB);
                }

                // Si las claves son iguales, significa que están en la misma saga.
                // Ordenar por el índice del juego dentro de la saga.
                if (sagaA && sagaB) {
                    return sagaA.gameIndex - sagaB.gameIndex;
                }
                return 0; // No debería ocurrir si los títulos son únicos.
            } else if (currentSort === "default") {
                const weightA = statusWeight[a.status] || 99;
                const weightB = statusWeight[b.status] || 99;
                if (weightA !== weightB) return weightA - weightB;
                const titleA = a.title.toLowerCase();
                const titleB = b.title.toLowerCase();
                if (titleA < titleB) return -1;
                if (titleA > titleB) return 1;
                return Number(a.year) - Number(b.year);
            }
            let valA, valB;
            if (currentSort === "score") {
                valA = Number(a.score || 0);
                valB = Number(b.score || 0);
            } else if (currentSort === "year") {
                // 'year' button now sorts by finishDate
                valA = a.finishDate || "0"; // Treat empty/missing dates as oldest
                valB = b.finishDate || "0";
            } else {
                // title
                valA = a.title.toLowerCase();
                valB = b.title.toLowerCase();
            }
            if (valA < valB) return isAscending ? -1 : 1;
            if (valA > valB) return isAscending ? 1 : -1;
            return 0;
        });

        const itemsToRender = filteredItems.slice(0, currentlyVisibleCount);

        gridEl.innerHTML = itemsToRender.map(renderItemCard).join("");

        if (itemsToRender.length < filteredItems.length) {
            loadMoreBtn.classList.remove("hidden");
        } else {
            loadMoreBtn.classList.add("hidden");
        }

        if (itemsToRender.length === 0) {
            gridEl.classList.add("hidden");
            emptyEl.classList.remove("hidden");
            emptyEl.classList.add("flex");
        } else {
            gridEl.classList.remove("hidden");
            emptyEl.classList.add("hidden");
            emptyEl.classList.remove("flex");
        }
    }

    window.filterStatus = (status, btn) => {
        currentStatus = status;
        currentlyVisibleCount = INITIAL_LOAD;
        document.querySelectorAll(".status-btn").forEach((b) => {
            b.classList.remove("active", "bg-white/10", "text-white");
        });
        btn.classList.add("active", "bg-white/10", "text-white");
        updateGrid();
    };
    window.filterType = (type, btn) => {
        currentType = type;
        currentlyVisibleCount = INITIAL_LOAD;
        document.querySelectorAll(".type-btn").forEach((b) => {
            b.classList.remove("active");
        });
        btn.classList.add("active");
        updateGrid();
    };
    window.setSort = (sort, btn) => {
        currentSort = sort;
        const orderBtn = document.getElementById("orderBtn");
        orderBtn.style.display = sort === "saga" ? "none" : "flex";
        if (sort === "saga") isAscending = false; // Sagas have a fixed order
        document.querySelectorAll(".sort-btn").forEach((b) => {
            b.classList.remove("bg-white/5", "text-white");
            b.classList.add("text-gray-500", "hover:text-white");
        });
        btn.classList.remove("text-gray-500", "hover:text-white");
        btn.classList.add("bg-white/5", "text-white");
        updateGrid();
    };
    window.toggleOrder = () => {
        if (currentSort === "saga") return;
        isAscending = !isAscending;
        const btn = document.getElementById("orderBtn");
        btn.innerHTML = isAscending
            ? '<i class="fa-solid fa-arrow-up-wide-short text-xs"></i>'
            : '<i class="fa-solid fa-arrow-down-wide-short text-xs"></i>';
        updateGrid();
    };

    textFilterInput.addEventListener("input", () => {
        currentlyVisibleCount = INITIAL_LOAD;
        updateGrid();
    });

    loadMoreBtn.addEventListener("click", () => {
        currentlyVisibleCount += LOAD_MORE_COUNT;
        updateGrid();
    });

    updateGrid();
</script>
<style>
    .type-btn.active {
        background-color: rgba(var(--accent-color-rgb), 0.2);
        color: var(--accent-color);
        border: 1px solid rgba(var(--accent-color-rgb), 0.3);
    }
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
