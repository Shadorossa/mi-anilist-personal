---
const { items } = Astro.props;
---

<section class="border-t border-white/5 pt-10" id="library-section">
    <div
        class="flex flex-col md:flex-row items-center justify-between gap-6 mb-8"
    >
        <h2
            class="text-xl font-bold text-white opacity-80 flex items-center gap-2"
        >
            <i class="fa-solid fa-layer-group text-indigo-500"></i> Biblioteca
        </h2>

        <nav
            class="bg-[#121215] p-1 rounded-xl border border-white/5 flex flex-wrap justify-center gap-1"
        >
            <button
                onclick="filterStatus('all', this)"
                class="status-btn active px-4 py-2 rounded-lg text-xs font-bold text-white bg-white/10 shadow-sm transition-all flex items-center gap-2"
            >
                <i class="fa-solid fa-border-all"></i> Todo
            </button>
            <button
                onclick="filterStatus('Jugando', this)"
                class="status-btn px-4 py-2 rounded-lg text-xs font-bold text-gray-400 hover:text-green-400 hover:bg-white/5 transition-all flex items-center gap-2"
            >
                <i class="fa-solid fa-gamepad"></i> Activo
            </button>
            <button
                onclick="filterStatus('Pendiente', this)"
                class="status-btn px-4 py-2 rounded-lg text-xs font-bold text-gray-400 hover:text-yellow-400 hover:bg-white/5 transition-all flex items-center gap-2"
            >
                <i class="fa-regular fa-clock"></i> Pendiente
            </button>
            <button
                onclick="filterStatus('Completado', this)"
                class="status-btn px-4 py-2 rounded-lg text-xs font-bold text-gray-400 hover:text-blue-400 hover:bg-white/5 transition-all flex items-center gap-2"
            >
                <i class="fa-solid fa-check-double"></i> Terminado
            </button>
            <button
                onclick="filterStatus('Abandonado', this)"
                class="status-btn px-4 py-2 rounded-lg text-xs font-bold text-gray-400 hover:text-red-400 hover:bg-white/5 transition-all flex items-center gap-2"
            >
                <i class="fa-solid fa-ban"></i> Droppeado
            </button>
        </nav>
    </div>

    <div
        class="flex flex-col xl:flex-row gap-4 mb-6 bg-[#121215] p-3 rounded-xl border border-white/5 items-center justify-between"
    >
        <div class="flex gap-2">
            <button
                onclick="filterType('all', this)"
                class="type-btn active px-3 py-1.5 rounded-lg text-[11px] font-bold bg-indigo-500/20 text-indigo-200 border border-indigo-500/30 transition-all"
                >Todos</button
            >
            <button
                onclick="filterType('game', this)"
                class="type-btn px-3 py-1.5 rounded-lg text-[11px] font-bold text-gray-500 hover:bg-white/5 transition-all"
                >Juegos</button
            >
            <button
                onclick="filterType('anime', this)"
                class="type-btn px-3 py-1.5 rounded-lg text-[11px] font-bold text-gray-500 hover:bg-white/5 transition-all"
                >Anime</button
            >
            <button
                onclick="filterType('manga', this)"
                class="type-btn px-3 py-1.5 rounded-lg text-[11px] font-bold text-gray-500 hover:bg-white/5 transition-all"
                >Manga</button
            >
        </div>

        <div class="flex items-center gap-2 border-l border-white/10 pl-4">
            <span
                class="text-[10px] uppercase font-bold text-gray-600 mr-2 hidden sm:inline"
                >Ordenar por:</span
            >

            <button
                onclick="setSort('score')"
                class="sort-btn active px-3 py-1.5 rounded-lg text-[11px] font-bold text-gray-400 hover:text-white flex items-center gap-2 transition-all bg-white/5 text-white"
            >
                <i class="fa-solid fa-star text-yellow-500"></i> Nota
            </button>
            <button
                onclick="setSort('year')"
                class="sort-btn px-3 py-1.5 rounded-lg text-[11px] font-bold text-gray-400 hover:text-white flex items-center gap-2 transition-all"
            >
                <i class="fa-regular fa-calendar"></i> Año
            </button>
            <button
                onclick="setSort('title')"
                class="sort-btn px-3 py-1.5 rounded-lg text-[11px] font-bold text-gray-400 hover:text-white flex items-center gap-2 transition-all"
            >
                <i class="fa-solid fa-font"></i> A-Z
            </button>

            <button
                id="orderBtn"
                onclick="toggleOrder()"
                class="ml-2 w-8 h-8 flex items-center justify-center rounded-lg bg-white/5 hover:bg-white/10 text-gray-300 transition-all"
            >
                <i class="fa-solid fa-arrow-down-wide-short"></i>
            </button>
        </div>
    </div>

    <div
        id="library-grid"
        class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-7 gap-4 md:gap-6 min-h-[400px]"
    >
        {
            items.map((item) => (
                <div
                    class="lib-item relative aspect-[2/3] rounded-xl overflow-hidden cursor-pointer group bg-[#18181b] ring-1 ring-white/5 shadow-sm hover:shadow-2xl hover:shadow-indigo-500/10 transition-all duration-300 hover:-translate-y-1"
                    data-type={item.type}
                    data-status={item.data.status}
                    data-score={item.data.score}
                    data-year={item.data.year === "N/A" ? 0 : item.data.year}
                    data-title={item.data.title}
                >
                    <img
                        src={item.data.cover}
                        loading="lazy"
                        class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 opacity-70 group-hover:opacity-100"
                    />

                    <div
                        class={`absolute top-2 right-2 px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-wider text-white shadow-lg border border-white/10 ${
                            item.data.status === "Jugando"
                                ? "bg-green-600"
                                : item.data.status === "Completado"
                                  ? "bg-blue-600"
                                  : item.data.status === "Pendiente"
                                    ? "bg-yellow-600"
                                    : "bg-red-600"
                        }`}
                    >
                        {item.data.status === "Jugando"
                            ? "Activo"
                            : item.data.status}
                    </div>

                    <div class="absolute inset-0 bg-gradient-to-t from-black/95 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4">
                        <div class="w-full">
                            <h3 class="text-white text-xs font-bold leading-tight line-clamp-2 mb-2">
                                {item.data.title}
                            </h3>
                            <div class="flex items-center justify-between border-t border-white/10 pt-2">
                                <span class="text-[10px] text-gray-400 font-bold">
                                    <i class="fa-regular fa-calendar mr-1" />{" "}
                                    {item.data.year}
                                </span>
                                <span class="text-[10px] text-yellow-500 font-bold bg-yellow-500/10 px-1.5 py-0.5 rounded">
                                    <i class="fa-solid fa-star mr-1" />{" "}
                                    {item.data.score}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            ))
        }
    </div>

    <div
        id="library-empty"
        class="hidden flex-col items-center justify-center py-20 text-gray-600"
    >
        <div
            class="w-20 h-20 bg-[#121215] rounded-full flex items-center justify-center mb-4 border border-white/5"
        >
            <i class="fa-solid fa-box-open text-3xl opacity-30"></i>
        </div>
        <p class="font-medium">No hay obras en esta sección.</p>
    </div>
</section>

<script is:inline>
    // --- ESTADO LOCAL ---
    let currentStatus = "all";
    let currentType = "all";
    let currentSort = "score";
    let isAscending = false;

    // --- REFERENCIAS ---
    const gridEl = document.getElementById("library-grid");
    const emptyEl = document.getElementById("library-empty");
    const allItems = Array.from(document.querySelectorAll(".lib-item"));

    // --- LÓGICA DE RENDERIZADO ---
    function updateGrid() {
        // 1. Filtrar
        const visibleItems = allItems.filter((item) => {
            const statusMatch =
                currentStatus === "all" ||
                item.dataset.status === currentStatus ||
                (currentStatus === "Jugando" &&
                    item.dataset.status === "Viendo"); // Compatibilidad anime

            const typeMatch =
                currentType === "all" || item.dataset.type === currentType;

            return statusMatch && typeMatch;
        });

        // 2. Ordenar
        visibleItems.sort((a, b) => {
            let valA, valB;
            if (currentSort === "score" || currentSort === "year") {
                valA = Number(a.dataset[currentSort]);
                valB = Number(b.dataset[currentSort]);
            } else {
                valA = a.dataset.title.toLowerCase();
                valB = b.dataset.title.toLowerCase();
            }

            if (valA < valB) return isAscending ? -1 : 1;
            if (valA > valB) return isAscending ? 1 : -1;
            return 0;
        });

        // 3. Actualizar DOM
        gridEl.innerHTML = "";
        visibleItems.forEach((item) => {
            // Reiniciar animación css
            item.style.animation = "none";
            item.offsetHeight; /* trigger reflow */
            item.style.animation = "fadeInUp 0.3s ease-out forwards";
            gridEl.appendChild(item);
        });

        // 4. Mostrar/Ocultar Empty State
        if (visibleItems.length === 0) {
            gridEl.classList.add("hidden");
            emptyEl.classList.remove("hidden");
            emptyEl.classList.add("flex");
        } else {
            gridEl.classList.remove("hidden");
            emptyEl.classList.add("hidden");
            emptyEl.classList.remove("flex");
        }
    }

    // --- MANEJADORES DE EVENTOS ---

    window.filterStatus = (status, btn) => {
        currentStatus = status;

        // Estilos Botones Status
        document.querySelectorAll(".status-btn").forEach((b) => {
            b.className =
                "status-btn px-4 py-2 rounded-lg text-xs font-bold text-gray-400 hover:bg-white/5 transition-all flex items-center gap-2";
        });

        // Estilo Activo Personalizado según el botón
        btn.className =
            "status-btn active px-4 py-2 rounded-lg text-xs font-bold text-white bg-white/10 shadow-sm transition-all flex items-center gap-2 ring-1 ring-white/10";

        updateGrid();
    };

    window.filterType = (type, btn) => {
        currentType = type;

        document.querySelectorAll(".type-btn").forEach((b) => {
            b.className =
                "type-btn px-3 py-1.5 rounded-lg text-[11px] font-bold text-gray-500 hover:bg-white/5 transition-all";
        });
        btn.className =
            "type-btn active px-3 py-1.5 rounded-lg text-[11px] font-bold bg-indigo-500/20 text-indigo-200 border border-indigo-500/30 transition-all";

        updateGrid();
    };

    window.setSort = (sort, btn) => {
        // Truco: como 'btn' no viene directo en onclick a veces, lo buscamos
        if (!btn) {
            // Buscar el botón correspondiente
        }
        currentSort = sort;

        document.querySelectorAll(".sort-btn").forEach((b) => {
            b.classList.remove("bg-white/5", "text-white");
            b.classList.add("text-gray-400");
        });

        // Activar el botón presionado
        const activeBtn = document.querySelector(
            `button[onclick="setSort('${sort}')"]`,
        );
        if (activeBtn) {
            activeBtn.classList.remove("text-gray-400");
            activeBtn.classList.add("bg-white/5", "text-white");
        }

        updateGrid();
    };

    window.toggleOrder = () => {
        isAscending = !isAscending;
        const btn = document.getElementById("orderBtn");
        btn.innerHTML = isAscending
            ? '<i class="fa-solid fa-arrow-up-wide-short"></i>'
            : '<i class="fa-solid fa-arrow-down-wide-short"></i>';
        updateGrid();
    };

    // Inicializar
    updateGrid();
</script>

<style>
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
