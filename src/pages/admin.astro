---
import { getCollection } from "astro:content";

// Componentes
import Sidebar from "../components/admin/Sidebar.astro";
import SearchPanel from "../components/admin/SearchPanel.astro";
import LibraryPanel from "../components/admin/LibraryPanel.astro";
import FavoritesPanel from "../components/admin/FavoritesPanel.astro";
import ProfilePanel from "../components/admin/ProfilePanel.astro";
import EditorModal from "../components/admin/EditorModal.astro";

// 1. CARGAR DATOS
const games = await getCollection("games").catch(() => []);
const anime = await getCollection("anime").catch(() => []);
const manga = await getCollection("manga").catch(() => []);

const localLibrary = [
    ...games.map((i) => ({ ...i.data, id: i.id, type: "game" })),
    ...anime.map((i) => ({ ...i.data, id: i.id, type: "anime" })),
    ...manga.map((i) => ({ ...i.data, id: i.id, type: "manga" })),
];

// 2. CARGAR DB CENTRAL
let db = { favorites: [], monthlyPicks: [] };
try {
    const d = await import("../content/database.json");
    db = d.default || d;
} catch (e) {}

const favoritesOrdered = db.favorites
    .map(title => localLibrary.find(item => item.title === title))
    .filter(item => item !== undefined);
---

<html lang="es" class="dark">
<head>
    <title>Nexus Admin</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* ESTILOS GLOBALES DEL ADMIN */
        body { 
            background-color: #050505; 
            color: #e4e4e7;
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            background-image: radial-gradient(circle at 50% 0%, #1a1a20 0%, #050505 80%);
        }
        .glass-panel { background: rgba(20, 20, 23, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .hide-scroll::-webkit-scrollbar { display: none; }
        
        .mini-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 1.25rem;
        }

        .tag-pill { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.08); color: #a1a1aa; border-radius: 99px; font-size: 0.7rem; font-weight: 600; letter-spacing: 0.5px; }
        .tag-pill button:hover { color: #f87171; transform: scale(1.1); }
        
        .stars-container i { cursor: pointer; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), color 0.2s; }
        .stars-container i:hover { transform: scale(1.3); }

        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .mask-fade-right { mask-image: linear-gradient(to right, black 80%, transparent 100%); -webkit-mask-image: linear-gradient(to right, black 80%, transparent 100%); }
    </style>
</head>
<body class="flex h-screen w-full selection:bg-indigo-500/30 selection:text-white">

    <Sidebar />

    <main class="flex-1 relative flex flex-col min-w-0">
        <SearchPanel />
        <LibraryPanel />
        <FavoritesPanel />
        <ProfilePanel />
    </main>

    <EditorModal />

    <script define:vars={{ localLibrary, favoritesOrdered, db }}>
        window.localLibrary = localLibrary;
        window.favoritesList = favoritesOrdered; 
        window.favoritesTitles = db.favorites || []; 
        window.monthlyPicksGlobal = db.monthlyPicks || []; 
    </script>

    <script is:inline>
        let currentSelection = null;
        let lastSearchResults = [];
        let isFavorite = false;
        
        document.getElementById('tagYear').value = new Date().getFullYear();

        // --- SISTEMA DE MODOS ---
        window.switchMode = (mode) => {
            document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active', 'text-white', 'bg-white/10'));
            document.getElementById(`${mode}-panel`).classList.remove('hidden');
            
            const btn = document.querySelector(`button[onclick="switchMode('${mode}')"]`);
            if(btn) btn.classList.add('active', 'text-white', 'bg-white/10');

            if(mode === 'library') renderLocalLibrary();
            if(mode === 'favorites') renderFavoritesSortable();
        }
        switchMode('search'); 

        // --- RENDER GRID ---
        function renderCard(item, onclickFunc) {
            const isFav = window.favoritesTitles.includes(item.title);
            return `
            <div onclick='${onclickFunc}(${JSON.stringify(item).replace(/'/g, "&#39;")})' class="group relative aspect-[2/3] rounded-lg overflow-hidden cursor-pointer bg-[#18181b] ring-1 ring-white/5 hover:ring-white/20 hover:scale-[1.03] transition-all duration-300">
                <img src="${item.cover}" class="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition-opacity">
                ${isFav ? '<div class="absolute top-1.5 left-1.5 text-red-500 drop-shadow-md text-xs"><i class="fa-solid fa-heart"></i></div>' : ''}
                <div class="absolute bottom-0 inset-x-0 p-2 bg-gradient-to-t from-black via-black/80 to-transparent"><p class="text-[9px] font-bold text-white truncate leading-tight">${item.title}</p></div>
            </div>`;
        }

        function renderLocalLibrary(filterText = '') {
            const filtered = window.localLibrary.filter(item => item.title.toLowerCase().includes(filterText.toLowerCase()));
            document.getElementById('localGrid').innerHTML = filtered.map(item => renderCard(item, 'openEditorLocal')).join('');
        }
        document.getElementById('localFilter').addEventListener('input', (e) => renderLocalLibrary(e.target.value));

        // --- BUSCADOR ---
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = document.getElementById('searchInput').value;
            const type = document.getElementById('mediaType').value;
            if(!query) return;
            
            document.getElementById('searchResults').innerHTML = `<div class="col-span-full py-10 text-center text-gray-500 text-xs">Buscando...</div>`;
            try {
                const res = await fetch(`/api/search.json?q=${encodeURIComponent(query)}&type=${type}`);
                const data = await res.json();
                window.lastSearchResults = data;
                document.getElementById('searchResults').innerHTML = data.map((item, idx) => renderCard(item, 'openEditorSearch')).join('');
            } catch (e) { document.getElementById('searchResults').innerHTML = `<p class="col-span-full text-center text-red-400 text-xs">Error</p>`; }
        });

        // --- EDITOR ---
        window.openEditorSearch = (idx) => {
            const item = window.lastSearchResults[idx];
            if(!item.id) item.id = Date.now();
            const type = document.getElementById('mediaType').value;
            fillEditor({ ...item, type: type === 'game' ? 'games' : (type === 'manga' ? 'manga' : (type === 'character' ? 'character' : 'anime')) });
        };
        window.openEditorLocal = (item) => fillEditor(item);

        function fillEditor(data) {
            currentSelection = data;
            document.getElementById('editor').classList.remove('hidden');
            
            document.getElementById('editorTitle').innerText = data.title;
            document.getElementById('editorYear').innerText = data.year || '----';
            document.getElementById('editorCover').src = data.cover;
            
            // Estado
            const statusToSelect = data.status || 'Jugando';
            document.querySelectorAll('input[name="status"]').forEach(r => {
                r.checked = (r.value === statusToSelect);
            });
            
            // Nota
            const score = data.score || 0;
            updateStarsVisual(score);

            // Favorito
            isFavorite = window.favoritesTitles.includes(data.title);
            updateFavBtn();

            // Mensuales
            renderMonthTags();
            checkScoreLock();
        }
        window.closeEditor = () => document.getElementById('editor').classList.add('hidden');

        // --- ESTRELLAS ---
        function updateStarsVisual(value) {
            document.getElementById('scoreRange').value = value;
            const visualScore = value / 2;
            document.getElementById('scoreText').innerText = visualScore;
            
            let html = '';
            for (let i = 1; i <= 5; i++) {
                let iconClass = "fa-regular fa-star text-[#333]"; 
                let colorClass = "text-[#333]";
                if (visualScore >= i) { iconClass = "fa-solid fa-star"; colorClass = "text-white"; } 
                else if (visualScore >= i - 0.5) { iconClass = "fa-solid fa-star-half-stroke"; colorClass = "text-white"; }
                
                html += `<span class="relative inline-block px-0.5 group/star">
                    <i class="${iconClass} ${colorClass} group-hover/star:text-white"></i>
                    <div class="absolute left-0 top-0 bottom-0 w-1/2 z-10" onclick="setScore(${i * 2 - 1})"></div>
                    <div class="absolute right-0 top-0 bottom-0 w-1/2 z-10" onclick="setScore(${i * 2})"></div>
                </span>`;
            }
            document.getElementById('starsVisual').innerHTML = html;
        }
        window.setScore = (val) => { if(!document.getElementById('scoreRange').disabled) updateStarsVisual(val); };

        window.checkScoreLock = () => {
            const status = document.querySelector('input[name="status"]:checked').value;
            const range = document.getElementById('scoreRange');
            const container = document.getElementById('scoreContainer');
            if (status === 'Completado') {
                range.disabled = false;
                container.style.opacity = '1'; container.style.pointerEvents = 'auto';
            } else {
                range.disabled = true;
                container.style.opacity = '0.3'; container.style.pointerEvents = 'none';
                updateStarsVisual(0);
            }
        };

        // --- FAVORITOS ---
        window.toggleFav = () => { isFavorite = !isFavorite; updateFavBtn(); }
        function updateFavBtn() {
            const btn = document.getElementById('favBtn');
            if(isFavorite) {
                btn.innerHTML = `<i class="fa-solid fa-heart text-red-500 drop-shadow-[0_0_10px_rgba(239,68,68,0.6)]"></i>`;
                btn.classList.add('scale-110');
            } else {
                btn.innerHTML = `<i class="fa-regular fa-heart"></i>`;
                btn.classList.remove('scale-110');
            }
        }

        // --- MENSUALES ---
        window.addMonthTag = () => {
            const m = document.getElementById('tagMonth').value;
            const y = document.getElementById('tagYear').value;
            if(!m || !y) return;
            const dateStr = `${y}-${m}`;
            const exists = window.monthlyPicksGlobal.some(entry => entry.month === dateStr && entry.title === currentSelection.title);
            if(!exists) {
                window.monthlyPicksGlobal.push({ 
                    month: dateStr, 
                    title: currentSelection.title, 
                    cover: currentSelection.cover 
                });
                window.monthlyPicksGlobal.sort((a,b) => b.month.localeCompare(a.month)); // Ordenar
                renderMonthTags();
            }
        };

        window.removeMonthTag = (dateStr) => {
            window.monthlyPicksGlobal = window.monthlyPicksGlobal.filter(entry => !(entry.month === dateStr && entry.title === currentSelection.title));
            renderMonthTags();
        };

        function renderMonthTags() {
            const container = document.getElementById('monthlyTagsContainer');
            const tags = window.monthlyPicksGlobal.filter(entry => entry.title === currentSelection.title);
            if(tags.length === 0) { container.innerHTML = '<span class="text-[10px] text-gray-700 italic pl-1">Sin historial</span>'; return; }
            container.innerHTML = tags.map(tag => {
                const [y, m] = tag.month.split('-');
                return `<div class="tag-pill">${m}/${y.slice(2)} <button onclick="removeMonthTag('${tag.month}')"><i class="fa-solid fa-xmark text-[9px]"></i></button></div>`;
            }).join('');
        }

        // --- GUARDAR ---
        document.getElementById('saveMediaBtn').addEventListener('click', async () => {
            const btn = document.getElementById('saveMediaBtn');
            const originalText = btn.innerText;
            btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i>`; btn.disabled = true;

            const status = document.querySelector('input[name="status"]:checked').value;
            const finalScore = status === 'Completado' ? Number(document.getElementById('scoreRange').value) : 0;

            if (isFavorite && !window.favoritesTitles.includes(currentSelection.title)) window.favoritesTitles.push(currentSelection.title);
            else if (!isFavorite) window.favoritesTitles = window.favoritesTitles.filter(t => t !== currentSelection.title);

            const payloadFile = { ...currentSelection, status, score: finalScore };
            const payloadDB = { 
                type: 'update_db', 
                favorites: window.favoritesTitles, 
                monthlyPicks: window.monthlyPicksGlobal 
            };

            try {
                await Promise.all([
                    fetch('/api/save.json', { method: 'POST', body: JSON.stringify(payloadFile) }),
                    fetch('/api/save.json', { method: 'POST', body: JSON.stringify(payloadDB) })
                ]);
                closeEditor();
            } catch (e) { console.error(e); }
            btn.innerText = originalText; btn.disabled = false;
        });

        // --- ORDENAR ---
        function renderFavoritesSortable() {
            const container = document.getElementById('favList');
            const favObjects = window.favoritesTitles.map(title => window.localLibrary.find(item => item.title === title)).filter(Boolean);
            container.innerHTML = favObjects.map(item => renderCard(item, '')).join('');
            new Sortable(container, { animation: 150 });
        }

        document.getElementById('saveOrderBtn').addEventListener('click', async () => {
            const btn = document.getElementById('saveOrderBtn');
            btn.innerText = "...";
            const newOrderTitles = [];
            // Fix lectura DOM
            document.querySelectorAll('#favList .group').forEach(el => {
                const title = el.querySelector('p').innerText;
                newOrderTitles.push(title);
            });
            window.favoritesTitles = newOrderTitles;
            await fetch('/api/save.json', { method: 'POST', body: JSON.stringify({ type: 'update_db', favorites: newOrderTitles }) });
            btn.innerText = "Hecho";
            setTimeout(() => btn.innerText = "Guardar Orden", 1500);
        });
    </script>
</body>
</html>