---
import fs from "node:fs";
import path from "node:path";
import "../styles/Asearch.css";

import Sidebar from "../components/admin/Sidebar.astro";
import SearchPanel from "../components/admin/SearchPanel.astro";
import LibraryPanel from "../components/admin/LibraryPanel.astro";
import CharacterPanel from "../components/admin/CharacterPanel.astro";
import MyCharactersPanel from "../components/admin/MyCharactersPanel.astro";
import FavoritesPanel from "../components/admin/FavoritesPanel.astro";
import SagasPanel from "../components/admin/SagasPanel.astro";
import EditorModal from "../components/admin/EditorModal.astro";
import CharacterModal from "../components/admin/CharacterModal.astro";
import SagaCoverPickerModal from "../components/admin/SagaCoverPickerModal.astro";

function readCollection(collectionName) {
    const dirPath = path.resolve(`./src/content/${collectionName}`);
    if (!fs.existsSync(dirPath)) return [];
    const files = fs.readdirSync(dirPath);
    return files
        .filter((file) => file.endsWith(".json"))
        .map((file) => {
            try {
                const filePath = path.join(dirPath, file);
                const content = fs.readFileSync(filePath, "utf-8");
                const data = JSON.parse(content);
                const type =
                    collectionName === "games" ? "game" : collectionName;
                return { ...data, id: file, type: type };
            } catch (e) {
                return null;
            }
        })
        .filter((item) => item !== null);
}

// 1. CARGAR DATOS
const localLibrary = [
    ...readCollection("games"),
    ...readCollection("anime"),
    ...readCollection("manga"),
];

function resolveImagePath(basePath) {
    if (
        !basePath ||
        basePath.startsWith("http") ||
        /\.\w{3,4}$/.test(basePath)
    ) {
        return basePath; // It's a full URL or already has an extension.
    }
    const publicDir = path.resolve("./public");
    const potentialPath = path.join(publicDir, basePath);
    const dir = path.dirname(potentialPath);
    const slug = path.basename(potentialPath);

    const commonExtensions = [".png", ".jpg", ".jpeg", ".gif", ".webp"];
    for (const ext of commonExtensions) {
        if (fs.existsSync(path.join(dir, `${slug}${ext}`)))
            return `${basePath}${ext}`;
    }
    return basePath; // Fallback to original path if not found.
}

let db = {
    favorites: [],
    monthlyPicks: [],
    characters: [],
    monthlyChars: [],
    likedCharacters: [],
    interestedCharacters: [],
    dislikedCharacters: [],
};
try {
    const d = await import("../content/database.json");
    db = d.default || d;
} catch (e) {}

db.characters = (db.characters || []).map((char) => ({
    ...char,
    cover: resolveImagePath(char.cover),
}));

db.likedCharacters = (db.likedCharacters || []).map((char) => ({
    ...char,
    cover: resolveImagePath(char.cover),
}));

db.dislikedCharacters = (db.dislikedCharacters || []).map((char) => ({
    ...char,
    cover: resolveImagePath(char.cover),
}));

db.interestedCharacters = (db.interestedCharacters || []).map((char) => ({
    ...char,
    cover: resolveImagePath(char.cover),
}));

const favoritesOrdered = db.favorites
    .map((title) => localLibrary.find((item) => item.title === title))
    .filter((item) => item !== undefined);
---

<html lang="es" class="dark">
    <head>
        <title>Nexus Admin</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"
        ></script>
    </head>
    <body>
        <Sidebar />

        <main class="admin-main">
            <SearchPanel />
            <LibraryPanel />
            <CharacterPanel />
            <MyCharactersPanel />
            <FavoritesPanel />
            <SagasPanel />
        </main>

        <EditorModal />
        <CharacterModal />
        <SagaCoverPickerModal />

        <script define:vars={{ localLibrary, favoritesOrdered, db }}>
            window.localLibrary = localLibrary;
            window.favoritesList = favoritesOrdered;
            window.favoritesTitles = db.favorites || [];
            window.monthlyPicksGlobal = db.monthlyPicks || [];
            window.charactersGlobal = db.characters || [];
            window.monthlyCharsGlobal = db.monthlyChars || [];
            window.likedCharactersGlobal = db.likedCharacters || [];
            window.sagas = db.sagas || {};
            window.interestedCharactersGlobal = db.interestedCharacters || [];
            window.dislikedCharactersGlobal = db.dislikedCharacters || [];
        </script>

        <script type="module">
            import { calculateRating } from "/src/utils/rating.js";
            window.calculateRating = calculateRating;
        </script>

        <script is:inline>
            // CSS para el panel de sagas

            const sagaStyles = `
                .saga-list { background-color: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 8px; padding: 6px; min-height: 80px; display: grid; grid-template-columns: repeat(auto-fill, minmax(64px, 1fr)); gap: 6px; align-content: start; }
                .saga-item { position: relative; aspect-ratio: 2 / 3; border-radius: 4px; cursor: grab; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
                .saga-item-cover { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
                .saga-item.sortable-ghost { background: #6366f1; opacity: 0.5; }
                .saga-container { background-color: #0c0c0e; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 8px; }
                .saga-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
                .saga-title-input { background: transparent; color: white; font-weight: bold; border: none; outline: none; width: 100%; font-size: 13px; }
                .delete-saga-btn { color: #71717a; cursor: pointer; }
                .delete-saga-btn:hover { color: #f87171; }

                /* Estilos para el picker de meses deshabilitado */
                .month-btn-item.disabled {
                    background: rgba(255, 255, 255, 0.02);
                    color: #404040;
                    cursor: not-allowed;
                    border-color: rgba(255, 255, 255, 0.03);
                    text-decoration: line-through;
                    text-decoration-color: rgba(239, 68, 68, 0.4);
                }
                .month-btn-item.disabled:hover {
                    background: rgba(255, 255, 255, 0.02);
                    color: #404040;
                }
            `;

            const styleSheet = document.createElement("style");
            styleSheet.innerText = sagaStyles;
            document.head.appendChild(styleSheet);

            // La función de acordeón ya no es necesaria con el nuevo layout
            window.toggleAccordion = () => {};
            window.toggleSagaFavorite = (sagaName, starIcon) => {
                const favIndex = window.favoritesTitles.findIndex(
                    (fav) => fav && fav.isSaga && fav.title === sagaName,
                );
                if (favIndex > -1) {
                    window.favoritesTitles.splice(favIndex, 1);
                    starIcon.classList.remove("text-yellow-400");
                    starIcon.classList.add(
                        "text-gray-600",
                        "hover:text-yellow-400",
                    );
                } else {
                    openSagaCoverPicker(sagaName);
                }
            };
            window.openSagaCoverPicker = (sagaName) => {
                const modal = document.getElementById(
                    "saga-cover-picker-modal",
                );
                const grid = document.getElementById("saga-picker-grid");
                const title = document.getElementById("saga-picker-title");

                const gamesInSaga = window.sagas[sagaName];
                if (!gamesInSaga || gamesInSaga.length === 0) {
                    alert(
                        "Esta saga no tiene juegos. Añade juegos a la saga primero.",
                    );
                    return;
                }

                title.innerText = `Elige una portada para la saga "${sagaName}"`;

                grid.innerHTML = gamesInSaga
                    .map((gameTitle) => {
                        const game = window.localLibrary.find(
                            (item) => item.title === gameTitle,
                        );
                        if (!game) return "";
                        return `
                        <div class="asearch-card" onclick="selectSagaCover('${sagaName}', '${game.cover}')">
                            <img src="${game.cover}" loading="lazy">
                            <div class="asearch-info">
                                <h4 class="asearch-title">${game.title}</h4>
                            </div>
                        </div>
                    `;
                    })
                    .join("");

                modal.classList.remove("hidden");
            };

            window.selectSagaCover = (sagaName, coverUrl) => {
                const sagaFavObject = {
                    isSaga: true,
                    title: sagaName,
                    cover: coverUrl,
                };
                window.favoritesTitles.push(sagaFavObject);

                const starIcon = document.querySelector(
                    `i[onclick*="'${sagaName}'"]`,
                );
                if (starIcon) {
                    starIcon.classList.add("text-yellow-400");
                    starIcon.classList.remove(
                        "text-gray-600",
                        "hover:text-yellow-400",
                    );
                }

                document
                    .getElementById("saga-cover-picker-modal")
                    .classList.add("hidden");
            };

            let currentSelection = null;
            let isFavorite = false;
            let currentPickYear = new Date().getFullYear();
            let currentCharPickYear = new Date().getFullYear();
            let activeCharCategory = "fav";
            let activeCharListSortable = null;
            // --- Lógica para ordenación de la biblioteca local ---
            let localCurrentSort = "saga";
            let localIsAscending = false;
            const sagaOrderMap = new Map();
            let sagaIndex = 0;
            for (const sagaName in window.sagas) {
                if (
                    Object.prototype.hasOwnProperty.call(window.sagas, sagaName)
                ) {
                    window.sagas[sagaName].forEach((title, gameIndex) => {
                        sagaOrderMap.set(title, {
                            sagaName,
                            sagaIndex,
                            gameIndex,
                        });
                    });
                    sagaIndex++;
                }
            }

            // Busca esta función en tu <script is:inline>
            window.handleCardClick = (actionName, encodedItem) => {
                if (!actionName) return; // No hacer nada si no hay acción
                try {
                    const item = JSON.parse(decodeURIComponent(encodedItem));

                    // Abrir editores de obras
                    if (actionName === "openEditorSearch")
                        openEditorSearch(item);
                    if (actionName === "openEditorLocal") openEditorLocal(item);

                    // --- ESTA ES LA LÍNEA QUE TE FALTA ---
                    if (actionName === "openCharEditor") openCharEditor(item);
                } catch (e) {
                    console.error("Error al procesar el click:", e);
                }
            };

            // --- 2. DEFINIR LA FUNCIÓN PARA ABRIR EL EDITOR DE PERSONAJES ---
            window.openCharEditor = (item) => {
                // Guardamos el personaje actual para poder usarlo al dar a "Guardar"
                currentSelection = item;

                // Obtenemos los elementos del modal (asegúrate de que los IDs coincidan con tu HTML)
                const modal = document.getElementById("charEditor");
                const img = document.getElementById("charCover");
                const nameInput = document.getElementById("charNameInput");
                const sourceInput = document.getElementById("charSourceInput");

                if (modal && img) {
                    img.src = item.cover;
                    nameInput.value = item.title;
                    sourceInput.value = item.source || ""; // Aquí aparece la obra original
                    document.getElementById(
                        "charEditorPreviewTitle",
                    ).innerText = item.title;

                    const charOffsetY =
                        item.coverOffsetY !== undefined
                            ? item.coverOffsetY
                            : 50;
                    document.getElementById("charCoverOffsetYRange").value =
                        charOffsetY;
                    document.getElementById("charEditorPreviewCover").src =
                        item.cover;
                    document.getElementById(
                        "charEditorPreviewCover",
                    ).style.objectPosition = `center ${charOffsetY}%`;
                    document.getElementById("charCoverOffsetText").innerText =
                        `${charOffsetY}%`;
                    setSliderPosition("char-custom-slider-thumb", charOffsetY);

                    currentCharPickYear = new Date().getFullYear();
                    document.getElementById("charPickYearDisplay").innerText =
                        currentCharPickYear;
                    renderCharMonthTags();

                    // Mostramos el modal
                    modal.classList.remove("hidden");
                }
            };

            // Función para cerrar el editor de personajes
            window.closeCharEditor = () => {
                document.getElementById("charEditor").classList.add("hidden");
            };

            function renderCard(item, actionName, isChar = false) {
                const isFav = window.favoritesTitles.includes(item.title);
                // encodeURIComponent doesn't escape single quotes, which breaks the onclick attribute.
                // We need to manually encode it for it to be a valid JS string inside the attribute.
                const safeItem = encodeURIComponent(
                    JSON.stringify(item),
                ).replace(/'/g, "%27");

                // Si es personaje, no mostramos estrellas
                const starRating =
                    !isChar && window.calculateRating
                        ? window.calculateRating(item.score || 0)
                        : 0;

                return `
    <div onclick="handleCardClick('${actionName}', '${safeItem}')" class="asearch-card" draggable="false">
        <img src="${item.cover}" class="${isChar ? "obj-top" : "obj-center"}" loading="lazy" draggable="false">
        ${!isChar && item.year ? `<div class="fixed-badge">${item.year}</div>` : ""}
        ${!isChar && isFav ? `<div class="heart-badge"><i class="fa-solid fa-heart"></i></div>` : ""}
        <div class="asearch-info">
            <h4 class="asearch-title">${item.title}</h4>
            ${!isChar && starRating > 0 ? `<div class="asearch-rating"><span>${starRating}</span><i class="fa-solid fa-star"></i></div>` : ""}
            ${isChar && item.source ? `<p class="text-[9px] text-pink-400 font-bold uppercase mt-2">${item.source}</p>` : ""}
        </div>
    </div>`;
            }

            window.setLocalSort = (sort, btn) => {
                localCurrentSort = sort;
                const orderBtn = document.getElementById("localOrderBtn");
                orderBtn.style.display = sort === "saga" ? "none" : "flex";
                if (sort === "saga") localIsAscending = false;
                document.querySelectorAll(".sort-btn-local").forEach((b) => {
                    b.classList.remove("bg-white/5", "text-white");
                    b.classList.add("text-gray-500");
                });
                btn.classList.remove("text-gray-500");
                btn.classList.add("bg-white/5", "text-white");
                renderLocalLibrary(
                    document.getElementById("localFilter").value,
                );
            };

            window.toggleLocalOrder = () => {
                if (localCurrentSort === "saga") return;
                localIsAscending = !localIsAscending;
                const btn = document.getElementById("localOrderBtn");
                btn.innerHTML = localIsAscending
                    ? '<i class="fa-solid fa-arrow-up-wide-short text-xs"></i>'
                    : '<i class="fa-solid fa-arrow-down-wide-short text-xs"></i>';
                renderLocalLibrary(
                    document.getElementById("localFilter").value,
                );
            };

            function renderLocalLibrary(filterText = "") {
                const filtered = window.localLibrary.filter((item) =>
                    item.title.toLowerCase().includes(filterText.toLowerCase()),
                );

                filtered.sort((a, b) => {
                    if (localCurrentSort === "saga") {
                        const sagaA = sagaOrderMap.get(a.title);
                        const sagaB = sagaOrderMap.get(b.title);
                        const sortKeyA = sagaA ? sagaA.sagaName : a.title;
                        const sortKeyB = sagaB ? sagaB.sagaName : b.title;
                        if (sortKeyA !== sortKeyB) {
                            return sortKeyA.localeCompare(sortKeyB);
                        }
                        if (sagaA && sagaB) {
                            return sagaA.gameIndex - sagaB.gameIndex;
                        }
                        return 0;
                    }
                    let valA, valB;
                    if (localCurrentSort === "score") {
                        valA = Number(a.score || 0);
                        valB = Number(b.score || 0);
                    } else if (localCurrentSort === "year") {
                        valA = a.finishDate || "0";
                        valB = b.finishDate || "0";
                    } else {
                        // title
                        valA = a.title.toLowerCase();
                        valB = b.title.toLowerCase();
                    }
                    if (valA < valB) return localIsAscending ? -1 : 1;
                    if (valA > valB) return localIsAscending ? 1 : -1;
                    return 0;
                });

                document.getElementById("localGrid").innerHTML = filtered
                    .map((item) => renderCard(item, "openEditorLocal"))
                    .join("");
            }
            document
                .getElementById("localFilter")
                .addEventListener("input", (e) =>
                    renderLocalLibrary(e.target.value),
                );

            window.openEditorSearch = (item) => {
                const type = document.getElementById("mediaType").value;
                const existing = window.localLibrary.find(
                    (l) => l.title === item.title,
                );
                const dataToFill = existing
                    ? existing
                    : {
                          ...item,
                          type:
                              type === "game"
                                  ? "games"
                                  : type === "manga"
                                    ? "manga"
                                    : "anime",
                      };
                fillEditor(dataToFill);
            };
            window.openEditorLocal = (item) => fillEditor(item);

            function fillEditor(data) {
                currentSelection = data;
                document.getElementById("editor").classList.remove("hidden");
                document.getElementById("editorTitle").innerText = data.title;
                document.getElementById("editorYear").innerText =
                    data.year || "----";
                document.getElementById("editorCover").src = data.cover;

                const status = data.status || "Jugando";
                document
                    .querySelectorAll('input[name="status"]')
                    .forEach((r) => {
                        r.checked = r.value === status;
                    });

                document.getElementById("startDate").value =
                    data.startDate || "";
                document.getElementById("finishDate").value =
                    data.finishDate || "";

                // --- Lógica para el nuevo PREVIEW de la cover ---
                document.getElementById("editorPreviewCover").src = data.cover;
                document.getElementById("editorPreviewTitle").innerText =
                    data.title;
                const offsetY =
                    data.coverOffsetY !== undefined ? data.coverOffsetY : 50;
                document.getElementById("coverOffsetYRange").value = offsetY;
                document.getElementById(
                    "editorPreviewCover",
                ).style.objectPosition = `center ${offsetY}%`;
                document.getElementById("coverOffsetText").innerText =
                    `${offsetY}%`;
                setSliderPosition("custom-slider-thumb", offsetY);

                currentPickYear = new Date().getFullYear();

                document.getElementById("pickYearDisplay").innerText =
                    currentPickYear;

                updateStarsVisual(data.score || 0);
                isFavorite = window.favoritesTitles.includes(data.title);
                updateFavBtn();
                renderMonthTags();
                checkScoreLock();
            }

            window.closeEditor = () =>
                document.getElementById("editor").classList.add("hidden");

            window.changePickYear = (delta) => {
                currentPickYear += delta;
                document.getElementById("pickYearDisplay").innerText =
                    currentPickYear;
                renderMonthTags();
            };

            window.toggleMonthPick = (month) => {
                const dateStr = `${currentPickYear}-${month}`;
                const exists = window.monthlyPicksGlobal.some(
                    (e) =>
                        e.month === dateStr &&
                        e.title === currentSelection.title,
                );

                if (exists) {
                    window.monthlyPicksGlobal =
                        window.monthlyPicksGlobal.filter(
                            (e) =>
                                !(
                                    e.month === dateStr &&
                                    e.title === currentSelection.title
                                ),
                        );
                } else {
                    window.monthlyPicksGlobal.push({
                        month: dateStr,
                        title: currentSelection.title,
                        cover: currentSelection.cover,
                    });
                    window.monthlyPicksGlobal.sort((a, b) =>
                        b.month.localeCompare(a.month),
                    );
                }
                renderMonthTags();
            };

            window.changeCharPickYear = (delta) => {
                currentCharPickYear += delta;
                document.getElementById("charPickYearDisplay").innerText =
                    currentCharPickYear;
                renderCharMonthTags();
            };

            window.toggleCharMonthPick = (month) => {
                const dateStr = `${currentCharPickYear}-${month}`;
                const exists = window.monthlyCharsGlobal.some(
                    (e) =>
                        e.month === dateStr &&
                        e.name === currentSelection.title,
                );

                if (exists) {
                    window.monthlyCharsGlobal =
                        window.monthlyCharsGlobal.filter(
                            (e) =>
                                !(
                                    e.month === dateStr &&
                                    e.name === currentSelection.title
                                ),
                        );
                } else {
                    window.monthlyCharsGlobal.push({
                        month: dateStr,
                        name: currentSelection.title,
                        cover: currentSelection.cover,
                    });
                    window.monthlyCharsGlobal.sort((a, b) =>
                        b.month.localeCompare(a.month),
                    );
                }
                renderCharMonthTags();
            };

            function renderCharMonthTags() {
                const container = document.getElementById(
                    "charMonthlyTagsContainer",
                );
                const tagsForCurrentWork = window.monthlyCharsGlobal.filter(
                    (entry) => entry.name === currentSelection.title,
                );
                container.innerHTML = tagsForCurrentWork
                    .map((tag) => `<div class="mini-tag">${tag.month}</div>`)
                    .join("");

                document
                    .querySelectorAll("#charEditor .month-btn-item")
                    .forEach((btn, index) => {
                        const month = (index + 1).toString().padStart(2, "0");
                        const dateStr = `${currentCharPickYear}-${month}`;

                        const isSelectedForThisWork = tagsForCurrentWork.some(
                            (tag) => tag.month === dateStr,
                        );

                        const isTakenByAnotherWork =
                            window.monthlyCharsGlobal.some(
                                (entry) =>
                                    entry.month === dateStr &&
                                    entry.name !== currentSelection.title,
                            );

                        btn.classList.remove("selected", "disabled");
                        btn.disabled = false;

                        if (isSelectedForThisWork) {
                            btn.classList.add("selected");
                        } else if (isTakenByAnotherWork) {
                            btn.classList.add("disabled");
                            btn.disabled = true;
                        }
                    });
            }

            function renderMonthTags() {
                const container = document.getElementById(
                    "monthlyTagsContainer",
                );
                const tagsForCurrentWork = window.monthlyPicksGlobal.filter(
                    (entry) => entry.title === currentSelection.title,
                );
                container.innerHTML = tagsForCurrentWork
                    .map((tag) => `<div class="mini-tag">${tag.month}</div>`)
                    .join("");

                document
                    .querySelectorAll(".month-btn-item")
                    .forEach((btn, index) => {
                        const month = (index + 1).toString().padStart(2, "0");
                        const dateStr = `${currentPickYear}-${month}`;

                        const isSelectedForThisWork = tagsForCurrentWork.some(
                            (tag) => tag.month === dateStr,
                        );

                        const isTakenByAnotherWork =
                            window.monthlyPicksGlobal.some(
                                (entry) =>
                                    entry.month === dateStr &&
                                    entry.title !== currentSelection.title,
                            );

                        btn.classList.remove("selected", "disabled");
                        btn.disabled = false;

                        if (isSelectedForThisWork) {
                            btn.classList.add("selected");
                        } else if (isTakenByAnotherWork) {
                            btn.classList.add("disabled");
                            btn.disabled = true;
                        }
                    });
            }

            // --- GUARDAR ---
            // --- DENTRO DEL SCRIPT IS:INLINE DE admin.astro ---

            document
                .getElementById("saveMediaBtn")
                .addEventListener("click", async () => {
                    const btn = document.getElementById("saveMediaBtn");
                    const originalText = btn.innerText;
                    btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Guardando...`;
                    btn.disabled = true;

                    // 1. Recoger valores del DOM
                    const status = document.querySelector(
                        'input[name="status"]:checked',
                    ).value;
                    const scoreVal =
                        document.getElementById("scoreRange").value;
                    const startDate =
                        document.getElementById("startDate").value;
                    const finishDate =
                        document.getElementById("finishDate").value;
                    const coverOffsetY =
                        document.getElementById("coverOffsetYRange").value;

                    // 2. Preparar los payloads
                    const fileData = {
                        title: currentSelection.title,
                        cover: currentSelection.cover,
                        year: currentSelection.year,
                        type: currentSelection.type,
                        status: status,
                        score: status === "Completado" ? Number(scoreVal) : 0,
                        startDate: startDate,
                        finishDate: finishDate,
                        coverOffsetY: Number(coverOffsetY),
                    };

                    if (
                        isFavorite &&
                        !window.favoritesTitles.includes(currentSelection.title)
                    ) {
                        window.favoritesTitles.push(currentSelection.title);
                    } else if (!isFavorite) {
                        window.favoritesTitles = window.favoritesTitles.filter(
                            (t) => t !== currentSelection.title,
                        );
                    }

                    const combinedPayload = {
                        fileData: fileData,
                        dbData: {
                            favorites: window.favoritesTitles,
                            monthlyPicks: window.monthlyPicksGlobal,
                        },
                    };

                    try {
                        const res = await fetch("/api/save.json", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(combinedPayload),
                        });

                        if (res.ok) {
                            // Éxito: recargar para que Astro reconozca los nuevos archivos .json
                            btn.innerHTML = `<i class="fa-solid fa-check"></i> ¡Guardado! Recargando...`;
                            // Pequeña espera y recarga con cache-busting para asegurar que se obtienen los datos más recientes.
                            setTimeout(() => {
                                // Añadimos un timestamp para evitar que el navegador sirva una versión cacheada de la página.
                                window.location.href =
                                    window.location.pathname +
                                    "?t=" +
                                    new Date().getTime();
                            }, 500);
                        } else {
                            throw new Error(
                                "Fallo en la respuesta del servidor",
                            );
                        }
                    } catch (e) {
                        console.error("Error al guardar:", e);
                        alert("Error al guardar los datos. Revisa la consola.");
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                });

            function updateStarsVisual(value) {
                document.getElementById("scoreRange").value = value;
                const visualScore = value / 2;
                document.getElementById("scoreText").innerText = (
                    value / 2
                ).toFixed(value % 2 === 0 ? 0 : 1);
                let html = "";
                for (let i = 1; i <= 5; i++) {
                    let iconClass = "fa-regular fa-star";
                    let colorClass = "text-gray-600"; // Color visible para estrellas vacías
                    if (visualScore >= i) {
                        iconClass = "fa-solid fa-star";
                        colorClass = "text-white";
                    } else if (visualScore >= i - 0.5) {
                        iconClass = "fa-solid fa-star-half-stroke";
                        colorClass = "text-white";
                    }
                    html += `<span class="relative inline-block px-0.5 group/star"><i class="${iconClass} ${colorClass} group-hover/star:text-white transition-colors"></i><div class="absolute left-0 top-0 bottom-0 w-1/2 z-10" onclick="setScore(${i * 2 - 1})"></div><div class="absolute right-0 top-0 bottom-0 w-1/2 z-10" onclick="setScore(${i * 2})"></div></span>`;
                }
                document.getElementById("starsVisual").innerHTML = html;
            }

            window.setScore = (val) => {
                if (!document.getElementById("scoreRange").disabled)
                    updateStarsVisual(val);
            };

            window.checkScoreLock = () => {
                const status = document.querySelector(
                    'input[name="status"]:checked',
                ).value;
                const range = document.getElementById("scoreRange");
                const container = document.getElementById("scoreContainer");
                if (status === "Completado") {
                    range.disabled = false;
                    container.style.opacity = "1";
                    container.style.pointerEvents = "auto";
                } else {
                    range.disabled = true;
                    container.style.opacity = "0.3";
                    container.style.pointerEvents = "none";
                    updateStarsVisual(0);
                }
            };

            window.toggleFav = () => {
                isFavorite = !isFavorite;
                updateFavBtn();
            };

            function updateFavBtn() {
                const btn = document.getElementById("favBtn");
                if (isFavorite) {
                    btn.innerHTML = `<i class="fa-solid fa-heart text-red-500 drop-shadow-[0_0_10px_rgba(239,68,68,0.6)]"></i>`;
                    btn.classList.add("scale-110");
                } else {
                    btn.innerHTML = `<i class="fa-regular fa-heart"></i>`;
                    btn.classList.remove("scale-110");
                }
            }

            document
                .getElementById("searchForm")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const q = document.getElementById("searchInput").value;
                    const t = document.getElementById("mediaType").value;
                    if (!q) return;
                    document.getElementById("searchResults").innerHTML = "...";
                    try {
                        const res = await fetch(
                            `/api/search.json?q=${encodeURIComponent(q)}&type=${t}`,
                        );
                        const data = await res.json();
                        const keywordsToFilter = [
                            "digital deluxe",
                            "collection",
                            "hd edition",
                        ];
                        const filteredData = data.filter((item) => {
                            const lowerCaseTitle = item.title.toLowerCase();
                            return !keywordsToFilter.some((keyword) =>
                                lowerCaseTitle.includes(keyword),
                            );
                        });
                        document.getElementById("searchResults").innerHTML =
                            filteredData
                                .map((i) => renderCard(i, "openEditorSearch"))
                                .join("");
                    } catch (e) {
                        console.error("Error en búsqueda:", e);
                        document.getElementById("searchResults").innerHTML =
                            `<p class="col-span-full text-red-400">Error al buscar</p>`;
                    }
                });

            window.switchMode = (mode) => {
                document
                    .querySelectorAll(".panel")
                    .forEach((p) => p.classList.add("hidden"));
                document
                    .querySelectorAll(".nav-btn")
                    .forEach((b) => b.classList.remove("active"));
                document
                    .getElementById(`${mode}-panel`)
                    .classList.remove("hidden");

                const btn = document.querySelector(
                    `button[onclick="switchMode('${mode}')"]`,
                );
                if (btn) btn.classList.add("active");

                if (mode === "library") renderLocalLibrary();
                if (mode === "favorites") renderFavWorksSortable();
                if (mode === "characters") {
                    document.getElementById("charResults").innerHTML = "";
                }
                if (mode === "my-characters") {
                    renderMyCharacters();
                }
                if (mode === "sagas") {
                    renderSagasPanel();
                }
            };

            function renderMyCharacters(filter = "") {
                const grid = document.getElementById("myCharsGrid");
                if (!grid) return;
                let list = [
                    ...(window.charactersGlobal || []),
                    ...(window.likedCharactersGlobal || []),
                    ...(window.interestedCharactersGlobal || []),
                    ...(window.dislikedCharactersGlobal || []),
                ].sort((a, b) => a.title.localeCompare(b.title));
                if (filter) {
                    list = list.filter((c) =>
                        c.title.toLowerCase().includes(filter.toLowerCase()),
                    );
                }
                if (list.length > 0) {
                    grid.innerHTML = list
                        .map((i) => renderCard(i, "openCharEditor", true))
                        .join("");
                } else {
                    grid.innerHTML =
                        '<p class="col-span-full text-white/5 text-[10px] py-4 pl-2">Biblioteca de personajes vacía.</p>';
                }
            }
            document
                .getElementById("myCharsFilter")
                .addEventListener("input", (e) =>
                    renderMyCharacters(e.target.value),
                );

            function renderSagaFavoriteCard(sagaItem) {
                return `
                <div class="asearch-card" data-issaga="true" data-title="${sagaItem.title}" data-cover="${sagaItem.cover}" draggable="false">
                    <img src="${sagaItem.cover}" class="obj-center" loading="lazy" draggable="false">
                    <div class="absolute top-1.5 right-1.5 text-[9px] font-bold uppercase bg-yellow-500/20 text-yellow-300 px-2 py-0.5 rounded-full border border-yellow-500/30">Saga</div>
                    <div class="asearch-info">
                        <h4 class="asearch-title">${sagaItem.title}</h4>
                    </div>
                </div>`;
            }

            function renderFavWorksSortable() {
                const container = document.getElementById("favList");

                if (window.favoritesTitles.length === 0) {
                    container.innerHTML =
                        '<p class="col-span-full text-center text-white/20 py-20">No tienes obras en favoritos aún.</p>';
                    return;
                }

                const listHtml = window.favoritesTitles
                    .map((fav) => {
                        if (typeof fav === "string") {
                            const item = window.localLibrary.find(
                                (i) => i.title === fav,
                            );
                            if (item) {
                                return renderCard(
                                    item,
                                    "openEditorLocal",
                                    false,
                                );
                            }
                            return ""; // Or a placeholder for a missing item
                        } else if (fav && fav.isSaga) {
                            return renderSagaFavoriteCard(fav);
                        }
                        return "";
                    })
                    .join("");

                container.innerHTML = listHtml;

                // Activamos la capacidad de arrastrar (Sortable)
                new Sortable(container, {
                    animation: 150,
                    ghostClass: "sortable-ghost-card",
                });
            }

            window.switchCharacterCategoryView = (category) => {
                activeCharCategory = category;
                document
                    .querySelectorAll(".category-tab-btn")
                    .forEach((btn) => btn.classList.remove("active"));
                document
                    .getElementById(`cat-btn-${category}`)
                    .classList.add("active");
                renderActiveCharList();
            };

            function renderActiveCharList() {
                if (activeCharListSortable) {
                    activeCharListSortable.destroy();
                }

                const container = document.getElementById("activeCharList");
                let list = [];
                switch (activeCharCategory) {
                    case "fav":
                        list = window.charactersGlobal;
                        break;
                    case "liked":
                        list = window.likedCharactersGlobal;
                        break;
                    case "interested":
                        list = window.interestedCharactersGlobal;
                        break;
                    case "disliked":
                        list = window.dislikedCharactersGlobal;
                        break;
                }

                container.innerHTML =
                    list.length > 0
                        ? list
                              .map(
                                  (item) => renderCard(item, "", true), // Deshabilitar click
                              )
                              .join("")
                        : '<p class="col-span-full text-center text-white/20 py-20 text-sm">Esta categoría está vacía.</p>';

                activeCharListSortable = new Sortable(container, {
                    group: "characters",
                    animation: 150,
                    ghostClass: "sortable-ghost-card",
                    onStart: function () {
                        document.body.classList.add("is-dragging-active");
                    },
                    onEnd: (evt) => {
                        document.body.classList.remove("is-dragging-active");
                        const reorderedTitles = Array.from(
                            evt.to.querySelectorAll(".asearch-title"),
                        ).map((el) => el.innerText);
                        const allChars = [
                            ...window.charactersGlobal,
                            ...window.likedCharactersGlobal,
                            ...window.interestedCharactersGlobal,
                            ...window.dislikedCharactersGlobal,
                        ];
                        const reorderedChars = reorderedTitles
                            .map((title) =>
                                allChars.find((c) => c.title === title),
                            )
                            .filter(Boolean);

                        switch (activeCharCategory) {
                            case "fav":
                                window.charactersGlobal = reorderedChars;
                                break;
                            case "liked":
                                window.likedCharactersGlobal = reorderedChars;
                                break;
                            case "interested":
                                window.interestedCharactersGlobal =
                                    reorderedChars;
                                break;
                            case "disliked":
                                window.dislikedCharactersGlobal =
                                    reorderedChars;
                                break;
                        }
                    },
                });
            }

            function setupCharacterFavoritesView() {
                // Update counters
                document.getElementById("fav-char-count").textContent =
                    window.charactersGlobal.length;
                document.getElementById("liked-char-count").textContent =
                    window.likedCharactersGlobal.length;
                document.getElementById("interested-char-count").textContent =
                    window.interestedCharactersGlobal.length;
                document.getElementById("disliked-char-count").textContent =
                    window.dislikedCharactersGlobal.length;

                switchCharacterCategoryView("fav");

                const moveCharacter = (title, targetCategory) => {
                    const allLists = {
                        fav: window.charactersGlobal,
                        liked: window.likedCharactersGlobal,
                        interested: window.interestedCharactersGlobal,
                        disliked: window.dislikedCharactersGlobal,
                    };
                    let character = null;
                    let sourceCategory = null;

                    for (const cat in allLists) {
                        const index = allLists[cat].findIndex(
                            (c) => c.title === title,
                        );
                        if (index > -1) {
                            character = allLists[cat].splice(index, 1)[0];
                            sourceCategory = cat;
                            break;
                        }
                    }

                    if (character) {
                        allLists[targetCategory].push(character);
                        if (sourceCategory === activeCharCategory) {
                            renderActiveCharList();
                        }
                        document.getElementById("fav-char-count").textContent =
                            allLists.fav.length;
                        document.getElementById(
                            "liked-char-count",
                        ).textContent = allLists.liked.length;
                        document.getElementById(
                            "interested-char-count",
                        ).textContent = allLists.interested.length;
                        document.getElementById(
                            "disliked-char-count",
                        ).textContent = allLists.disliked.length;
                    }
                };

                ["fav", "liked", "interested", "disliked"].forEach(
                    (category) => {
                        const dropZone = document.getElementById(
                            `cat-btn-${category}`,
                        );
                        new Sortable(dropZone, {
                            group: {
                                name: "characters",
                                pull: false,
                                put: true,
                            },
                            ghostClass: "sortable-ghost-hidden", // Also hide the ghost in the drop zone
                            onAdd: (evt) => {
                                const characterTitle =
                                    evt.item.querySelector(
                                        ".asearch-title",
                                    ).innerText;
                                moveCharacter(characterTitle, category);
                                evt.item.remove();
                            },
                        });
                    },
                );
            }

            window.switchFavView = (type) => {
                const worksView = document.getElementById("fav-works-view");
                const charsView = document.getElementById("fav-chars-view");
                const btnWorks = document.getElementById("btn-fav-works");
                const btnChars = document.getElementById("btn-fav-chars");
                const bg = document.getElementById("fav-tab-bg");

                if (type === "works") {
                    worksView.classList.remove("hidden");
                    charsView.classList.add("hidden");
                    bg.style.transform = "translateX(0)";
                    worksView.classList.add("flex");
                    btnWorks.classList.remove("opacity-50");
                    btnChars.classList.add("opacity-50");
                } else {
                    worksView.classList.add("hidden");
                    worksView.classList.remove("flex");
                    charsView.classList.remove("hidden");
                    bg.style.transform = "translateX(100%)";
                    btnChars.classList.remove("opacity-50");
                    btnWorks.classList.add("opacity-50");
                    setupCharacterFavoritesView();
                }
            };

            document
                .getElementById("saveCharOrderBtn")
                .addEventListener("click", async () => {
                    const btn = document.getElementById("saveCharOrderBtn");
                    const originalText = btn.innerHTML;
                    btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i>`;
                    btn.disabled = true;

                    try {
                        await fetch("/api/save.json", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                dbData: {
                                    characters: window.charactersGlobal,
                                    likedCharacters:
                                        window.likedCharactersGlobal,
                                    interestedCharacters:
                                        window.interestedCharactersGlobal,
                                    dislikedCharacters:
                                        window.dislikedCharactersGlobal,
                                },
                            }),
                        });
                        btn.innerHTML = `<i class="fa-solid fa-check"></i> ¡Guardado!`;
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }, 2000);
                    } catch (e) {
                        console.error(e);
                        btn.innerHTML = "Error";
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }, 2000);
                    }
                });

            document
                .getElementById("saveOrderBtn")
                .addEventListener("click", async () => {
                    const btn = document.getElementById("saveOrderBtn");
                    const originalText = btn.innerHTML;
                    btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Guardando...`;
                    btn.disabled = true;

                    const newOrder = [];
                    document
                        .querySelectorAll("#favList .asearch-card")
                        .forEach((card) => {
                            if (card.dataset.issaga === "true") {
                                newOrder.push({
                                    isSaga: true,
                                    title: card.dataset.title,
                                    cover: card.dataset.cover,
                                });
                            } else {
                                const titleEl =
                                    card.querySelector(".asearch-title");
                                if (titleEl) {
                                    newOrder.push(titleEl.innerText);
                                }
                            }
                        });

                    window.favoritesTitles = newOrder;

                    try {
                        await fetch("/api/save.json", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                dbData: { favorites: newOrder },
                            }),
                        });
                        btn.innerHTML = `<i class="fa-solid fa-check"></i> ¡Guardado!`;
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }, 2000);
                    } catch (e) {
                        console.error(e);
                        btn.innerHTML = "Error al guardar";
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }, 2000);
                    }
                });

            // --- SAGAS ---
            function renderSagaItem(game) {
                if (!game) return "";
                return `
                    <div class="saga-item" data-title="${game.title}" title="${game.title}">
                        <img src="${game.cover}" class="saga-item-cover" loading="lazy">
                    </div>
                `;
            }

            function romanToArabic(s) {
                if (!s || typeof s !== "string") return null;
                const roman = s.toUpperCase();
                if (!/^[IVXLCDM]+$/.test(roman)) return null;
                const map = {
                    I: 1,
                    V: 5,
                    X: 10,
                    L: 50,
                    C: 100,
                    D: 500,
                    M: 1000,
                };
                let result = 0;
                for (let i = 0; i < roman.length; i++) {
                    const current = map[roman[i]];
                    const next = map[roman[i + 1]];
                    if (next && current < next) {
                        result -= current;
                    } else {
                        result += current;
                    }
                }
                return result;
            }

            function getSortValue(title) {
                const trimmedTitle = title.trim();
                let match = trimmedTitle.match(/^(.*)\s(F)$/i);
                if (match) return { value: 1000, base: match[1].trim() };
                match = trimmedTitle.match(/^(.*)\s(\d+)$/);
                if (match)
                    return {
                        value: parseInt(match[2], 10),
                        base: match[1].trim(),
                    };
                match = trimmedTitle.match(/^(.*)\s([IVXLCDM]+)$/i);
                if (match) {
                    const num = romanToArabic(match[2]);
                    if (num !== null) {
                        return { value: num, base: match[1].trim() };
                    }
                }
                return { value: 1, base: trimmedTitle };
            }

            function renderSagasPanel() {
                const findItem = (title) =>
                    window.localLibrary.find((item) => item.title === title);

                // 1. Auto-assignment phase
                const allItemTitles = new Set(
                    window.localLibrary.map((item) => item.title),
                );
                const allSagaNames = Object.keys(window.sagas);
                let assignedInSagas = new Set(
                    Object.values(window.sagas).flat(),
                );
                let currentlyUnassigned = new Set(
                    [...allItemTitles].filter(
                        (title) => !assignedInSagas.has(title),
                    ),
                );

                const modifiedSagas = new Set();

                for (const sagaName of allSagaNames) {
                    const titlesToMove = [];
                    for (const unassignedTitle of currentlyUnassigned) {
                        const { base } = getSortValue(unassignedTitle);
                        if (base.toLowerCase() === sagaName.toLowerCase()) {
                            titlesToMove.push(unassignedTitle);
                        }
                    }

                    if (titlesToMove.length > 0) {
                        window.sagas[sagaName].push(...titlesToMove);
                        titlesToMove.forEach((title) =>
                            currentlyUnassigned.delete(title),
                        );
                        modifiedSagas.add(sagaName);
                    }
                }

                // Process sagas: remove duplicates and sort only if modified
                for (const sagaName in window.sagas) {
                    window.sagas[sagaName] = [
                        ...new Set(window.sagas[sagaName]),
                    ]; // Remove duplicates

                    if (modifiedSagas.has(sagaName)) {
                        window.sagas[sagaName].sort((a, b) => {
                            const valA = getSortValue(a).value;
                            const valB = getSortValue(b).value;
                            return valB - valA; // Descending
                        });
                    }
                }

                // 2. Categorize remaining unassigned
                const suggestedTitles = [];
                const trulyUnassignedTitles = [];
                const sagaNamesLower = allSagaNames.map((s) => s.toLowerCase());

                for (const title of currentlyUnassigned) {
                    let isSuggestion = false;
                    for (const sagaName of sagaNamesLower) {
                        if (title.toLowerCase().includes(sagaName)) {
                            isSuggestion = true;
                            break;
                        }
                    }
                    if (isSuggestion) {
                        suggestedTitles.push(title);
                    } else {
                        trulyUnassignedTitles.push(title);
                    }
                }

                // 3. Render UI
                const unassignedContainer =
                    document.getElementById("unassigned-games");
                const suggestedContainer =
                    document.getElementById("suggested-games");
                const sagasContainer =
                    document.getElementById("sagas-container");

                unassignedContainer.innerHTML = trulyUnassignedTitles
                    .map(findItem)
                    .filter(Boolean)
                    .map(renderSagaItem)
                    .join("");
                suggestedContainer.innerHTML = suggestedTitles
                    .map(findItem)
                    .filter(Boolean)
                    .map(renderSagaItem)
                    .join("");

                sagasContainer.innerHTML = Object.entries(window.sagas)
                    .sort((a, b) => a[0].localeCompare(b[0]))
                    .map(([sagaName, games]) => {
                        const isFav = window.favoritesTitles.some(
                            (fav) =>
                                fav && fav.isSaga && fav.title === sagaName,
                        );
                        const gameObjects = games.map(findItem).filter(Boolean);
                        return `
                        <div class="saga-container" data-saga-name="${sagaName}">
                            <div class="saga-header">
                                <input type="text" class="saga-title-input" value="${sagaName}">
                                <div class="flex items-center gap-3">
                                    <i class="fa-solid fa-star cursor-pointer ${
                                        isFav
                                            ? "text-yellow-400"
                                            : "text-gray-600 hover:text-yellow-400"
                                    }" title="Marcar como Favorito" onclick="toggleSagaFavorite('${sagaName}', this)"></i>
                                    <i class="fa-solid fa-trash-can delete-saga-btn" onclick="this.closest('.saga-container').remove()"></i>
                                </div>
                            </div>
                            <div class="saga-list">
                                ${gameObjects.map(renderSagaItem).join("")}
                            </div>
                        </div>
                    `;
                    })
                    .join("");

                // Init Sortable
                new Sortable(unassignedContainer, {
                    group: "sagas",
                    animation: 150,
                    ghostClass: "sortable-ghost",
                });
                new Sortable(suggestedContainer, {
                    group: "sagas",
                    animation: 150,
                    ghostClass: "sortable-ghost",
                });
                document
                    .querySelectorAll("#sagas-container .saga-list")
                    .forEach((el) => {
                        new Sortable(el, {
                            group: "sagas",
                            animation: 150,
                            ghostClass: "sortable-ghost",
                        });
                    });
            }

            document
                .getElementById("addSagaBtn")
                .addEventListener("click", () => {
                    const sagasContainer =
                        document.getElementById("sagas-container");
                    const newSagaName = `Nueva Saga ${Object.keys(window.sagas).length + 1}`;
                    const newSagaEl = document.createElement("div");
                    newSagaEl.className = "saga-container";
                    newSagaEl.dataset.sagaName = newSagaName;
                    newSagaEl.innerHTML = `
                    <div class="saga-header">
                        <input type="text" class="saga-title-input" value="${newSagaName}">
                        <i class="fa-solid fa-trash-can delete-saga-btn" onclick="this.closest('.saga-container').remove()"></i>
                    </div>
                    <div class="saga-list"></div>
                `;
                    sagasContainer.appendChild(newSagaEl);
                    new Sortable(newSagaEl.querySelector(".saga-list"), {
                        group: "sagas",
                        animation: 150,
                        ghostClass: "sortable-ghost",
                    });
                });

            document
                .getElementById("saveSagasBtn")
                .addEventListener("click", async () => {
                    const btn = document.getElementById("saveSagasBtn");
                    const originalText = btn.innerHTML;
                    btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i>`;
                    btn.disabled = true;

                    const newSagas = {};
                    document
                        .querySelectorAll("#sagas-container .saga-container")
                        .forEach((container) => {
                            const sagaName = container
                                .querySelector(".saga-title-input")
                                .value.trim();
                            if (sagaName) {
                                const games = Array.from(
                                    container.querySelectorAll(".saga-item"),
                                ).map((item) => item.dataset.title);
                                newSagas[sagaName] = games;
                            }
                        });

                    window.sagas = newSagas;

                    try {
                        await fetch("/api/save.json", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                dbData: { sagas: newSagas },
                            }),
                        });
                        btn.innerHTML = `<i class="fa-solid fa-check"></i>`;
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }, 2000);
                    } catch (e) {
                        console.error(e);
                        btn.innerHTML = "Error";
                        setTimeout(() => {
                            btn.innerHTML = originalText;
                            btn.disabled = false;
                        }, 2000);
                    }
                });

            // --- BUSCADOR DE PERSONAJES ---
            const charForm = document.getElementById("charSearchForm");

            if (charForm) {
                charForm.addEventListener("submit", async (e) => {
                    e.preventDefault(); // CRÍTICO: Evita que el Enter te lleve a otro lado

                    const q = document.getElementById("charInput").value;
                    if (!q) return;

                    const resultsGrid = document.getElementById("charResults");
                    resultsGrid.innerHTML =
                        '<p class="col-span-full text-indigo-400 text-xs py-4 text-center animate-pulse">Consultando Giant Bomb...</p>';

                    try {
                        const res = await fetch(
                            `/api/search.json?q=${encodeURIComponent(q)}&type=character`,
                        );
                        const data = await res.json();

                        if (!data || data.length === 0) {
                            resultsGrid.innerHTML =
                                '<p class="col-span-full text-white/20 text-xs py-4 text-center">No se encontraron personajes.</p>';
                        } else {
                            // Usamos la función renderCard que ya tienes, pasando true al final para indicar que es personaje
                            resultsGrid.innerHTML = data
                                .map((i) =>
                                    renderCard(i, "openCharEditor", true),
                                )
                                .join("");
                        }
                    } catch (e) {
                        console.error("Error en la búsqueda:", e);
                        resultsGrid.innerHTML =
                            '<p class="col-span-full text-red-500/50 text-xs py-4 text-center">Error de conexión con el servidor.</p>';
                    }
                });
            }

            document
                .getElementById("deleteCharBtn")
                .addEventListener("click", async () => {
                    if (!currentSelection || !currentSelection.id) return;
                    if (
                        !confirm(
                            `¿Seguro que quieres eliminar a "${currentSelection.title}" de todas las listas?`,
                        )
                    )
                        return;

                    // Remove from all lists
                    window.charactersGlobal = window.charactersGlobal.filter(
                        (c) => c.id !== currentSelection.id,
                    );
                    window.likedCharactersGlobal =
                        window.likedCharactersGlobal.filter(
                            (c) => c.id !== currentSelection.id,
                        );
                    window.interestedCharactersGlobal =
                        window.interestedCharactersGlobal.filter(
                            (c) => c.id !== currentSelection.id,
                        );
                    window.dislikedCharactersGlobal =
                        window.dislikedCharactersGlobal.filter(
                            (c) => c.id !== currentSelection.id,
                        );
                    window.monthlyCharsGlobal =
                        window.monthlyCharsGlobal.filter(
                            (p) => p.name !== currentSelection.title,
                        );

                    await saveAllCharacterLists();
                    closeCharEditor();
                    renderMyCharacters();
                    setupCharacterFavoritesView();
                });
            // --- GUARDAR PERSONAJE ---
            document
                .getElementById("saveCharBtn")
                .addEventListener("click", async () => {
                    if (!currentSelection) return;

                    const name = document.getElementById("charNameInput").value;
                    const source =
                        document.getElementById("charSourceInput").value;
                    const coverOffsetY = document.getElementById(
                        "charCoverOffsetYRange",
                    ).value;

                    const updatedChar = {
                        ...currentSelection,
                        title: name,
                        source: source,
                        coverOffsetY: Number(coverOffsetY),
                    };

                    const favIndex = window.charactersGlobal.findIndex(
                        (c) => c.id === updatedChar.id,
                    );
                    const likedIndex = window.likedCharactersGlobal.findIndex(
                        (c) => c.id === updatedChar.id,
                    );
                    const interestedIndex =
                        window.interestedCharactersGlobal.findIndex(
                            (c) => c.id === updatedChar.id,
                        );
                    const dislikedIndex =
                        window.dislikedCharactersGlobal.findIndex(
                            (c) => c.id === updatedChar.id,
                        );

                    if (favIndex > -1) {
                        window.charactersGlobal[favIndex] = updatedChar;
                    } else if (likedIndex > -1) {
                        window.likedCharactersGlobal[likedIndex] = updatedChar;
                    } else if (interestedIndex > -1) {
                        window.interestedCharactersGlobal[interestedIndex] =
                            updatedChar;
                    } else if (dislikedIndex > -1) {
                        window.dislikedCharactersGlobal[dislikedIndex] =
                            updatedChar;
                    } else {
                        // Por defecto, un personaje nuevo se añade a "Me Gustan"
                        window.likedCharactersGlobal.push(updatedChar);
                    }

                    try {
                        await saveAllCharacterLists();
                        closeCharEditor();
                        if (
                            !document
                                .getElementById("my-characters-panel")
                                .classList.contains("hidden")
                        ) {
                            renderMyCharacters(
                                document.getElementById("myCharsFilter").value,
                            );
                        }
                    } catch (e) {
                        console.error("Error saving character:", e);
                        alert("Error al guardar el personaje.");
                    }
                });

            async function saveAllCharacterLists() {
                const payload = {
                    dbData: {
                        characters: window.charactersGlobal,
                        likedCharacters: window.likedCharactersGlobal,
                        dislikedCharacters: window.dislikedCharactersGlobal,
                        interestedCharacters: window.interestedCharactersGlobal,
                        monthlyChars: window.monthlyCharsGlobal,
                    },
                };
                const res = await fetch("/api/save.json", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload),
                });
                if (!res.ok) {
                    throw new Error(
                        "Server error while saving character lists",
                    );
                }
            }

            document
                .getElementById("deleteMediaBtn")
                .addEventListener("click", async () => {
                    if (!currentSelection || !currentSelection.id) return;

                    if (
                        !confirm(
                            `¿Seguro que quieres eliminar "${currentSelection.title}" de tu colección? Esta acción no se puede deshacer.`,
                        )
                    ) {
                        return;
                    }

                    const btn = document.getElementById("deleteMediaBtn");
                    const originalText = btn.innerText;
                    btn.innerText = "Eliminando...";
                    btn.disabled = true;

                    try {
                        const deleteRes = await fetch("/api/delete.json", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                type: currentSelection.type,
                                id: currentSelection.id,
                            }),
                        });
                        if (!deleteRes.ok)
                            throw new Error("File deletion failed");

                        window.favoritesTitles = window.favoritesTitles.filter(
                            (t) => {
                                if (typeof t === "string")
                                    return t !== currentSelection.title;
                                return true;
                            },
                        );
                        window.monthlyPicksGlobal =
                            window.monthlyPicksGlobal.filter(
                                (p) => p.title !== currentSelection.title,
                            );

                        const saveDbRes = await fetch("/api/save.json", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                dbData: {
                                    favorites: window.favoritesTitles,
                                    monthlyPicks: window.monthlyPicksGlobal,
                                },
                            }),
                        });
                        if (!saveDbRes.ok) throw new Error("DB update failed");

                        btn.innerText = "¡Eliminado!";
                        setTimeout(() => window.location.reload(), 500);
                    } catch (e) {
                        console.error("Error deleting item:", e);
                        alert("Error al eliminar la obra.");
                        btn.innerText = originalText;
                        btn.disabled = false;
                    }
                });

            switchMode("search");

            // --- Custom Slider Logic ---
            function setSliderPosition(thumbId, value) {
                const thumb = document.getElementById(thumbId);
                if (thumb) {
                    const percentage = 100 - value; // Invert value for top position
                    thumb.style.top = `calc(${percentage}% - 8px)`;
                }
            }

            function initCustomSlider(containerId, thumbId, onUpdate) {
                const container = document.getElementById(containerId);
                const thumb = document.getElementById(thumbId);
                if (!container || !thumb) return;

                let isDragging = false;

                const onDrag = (e) => {
                    if (!isDragging) return;
                    e.preventDefault();
                    const rect = container.getBoundingClientRect();
                    const y = (e.clientY || e.touches[0].clientY) - rect.top;
                    const percentage = Math.max(
                        0,
                        Math.min(100, (y / rect.height) * 100),
                    );

                    thumb.style.top = `calc(${percentage}% - 8px)`;
                    onUpdate(100 - percentage); // Invert for object-position
                };

                const stopDrag = () => {
                    isDragging = false;
                    document.removeEventListener("mousemove", onDrag);
                    document.removeEventListener("mouseup", stopDrag);
                    document.removeEventListener("touchmove", onDrag);
                    document.removeEventListener("touchend", stopDrag);
                };

                const startDrag = (e) => {
                    e.preventDefault();
                    isDragging = true;
                    document.addEventListener("mousemove", onDrag);
                    document.addEventListener("mouseup", stopDrag);
                    document.addEventListener("touchmove", onDrag);
                    document.addEventListener("touchend", stopDrag);
                };

                thumb.addEventListener("mousedown", startDrag);
                thumb.addEventListener("touchstart", startDrag);
                container.addEventListener("click", (e) => {
                    if (e.target === thumb) return;
                    const rect = container.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    const percentage = Math.max(
                        0,
                        Math.min(100, (y / rect.height) * 100),
                    );
                    thumb.style.top = `calc(${percentage}% - 8px)`;
                    onUpdate(100 - percentage);
                });
            }

            initCustomSlider(
                "custom-slider-container",
                "custom-slider-thumb",
                (pos) => {
                    const position = Math.round(pos);
                    document.getElementById(
                        "editorPreviewCover",
                    ).style.objectPosition = `center ${position}%`;
                    document.getElementById("coverOffsetText").innerText =
                        `${position}%`;
                    document.getElementById("coverOffsetYRange").value =
                        position;
                },
            );

            initCustomSlider(
                "char-custom-slider-container",
                "char-custom-slider-thumb",
                (pos) => {
                    const position = Math.round(pos);
                    document.getElementById(
                        "charEditorPreviewCover",
                    ).style.objectPosition = `center ${position}%`;
                    document.getElementById("charCoverOffsetText").innerText =
                        `${position}%`;
                    document.getElementById("charCoverOffsetYRange").value =
                        position;
                },
            );

            // Auto-update finish date year based on start date year
            document
                .getElementById("startDate")
                .addEventListener("change", (e) => {
                    const startDateValue = e.target.value;
                    if (!startDateValue) return;

                    const startYear = startDateValue.substring(0, 4);

                    const finishDateInput =
                        document.getElementById("finishDate");
                    const finishDateValue = finishDateInput.value;

                    if (finishDateValue) {
                        const restOfFinishDate = finishDateValue.substring(4); // -MM-DD
                        finishDateInput.value = `${startYear}${restOfFinishDate}`;
                    }
                });
        </script>
    </body>
</html>
