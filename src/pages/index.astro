---
import { getCollection } from "astro:content";

// --- CONFIGURACIÓN Y DATOS ---
let profile = { username: "Admin", bio: "Explorador de mundos digitales." };
try {
	const config = await import("../content/config.json");
	profile = config.default || config;
} catch (e) {}

const bannerPath = "/img/profile/banner.png";
const avatarPath = "/img/profile/pic.png";

// Cargar Colecciones
const games = await getCollection("games").catch(() => []);
const anime = await getCollection("anime").catch(() => []);
const manga = await getCollection("manga").catch(() => []);

const allContent = [
	...games.map((i) => ({ ...i, type: "game" })),
	...anime.map((i) => ({ ...i, type: "anime" })),
	...manga.map((i) => ({ ...i, type: "manga" })),
];

// Ordenar por Puntuación para los favoritos automáticos
const favorites = allContent
	.filter((i) => i.data.score >= 9)
	.sort((a, b) => b.data.score - a.data.score)
	.slice(0, 5);

// --- DATOS MANUALES (PARA EL DISEÑO) ---
// Como tu backend actual no soporta esto aun, lo simulamos aquí para el diseño visual.
// En el futuro, esto podría venir de un archivo json.

const monthlyPicks = [
	{
		month: "OCT",
		year: "2023",
		title: "Cyberpunk 2077",
		cover: "https://images.igdb.com/igdb/image/upload/t_cover_big/co2mjs.jpg",
	},
	{
		month: "NOV",
		year: "2023",
		title: "Pluto",
		cover: "https://s4.anilist.co/file/anilistcdn/media/anime/cover/large/bx140352-Rh4fC7Zz9g5C.jpg",
	},
	{
		month: "DIC",
		year: "2023",
		title: "Baldur's Gate 3",
		cover: "https://images.igdb.com/igdb/image/upload/t_cover_big/co670h.jpg",
	},
	{
		month: "ENE",
		year: "2024",
		title: "Frieren",
		cover: "https://s4.anilist.co/file/anilistcdn/media/anime/cover/large/bx154587-n1fmjvsLPF0p.jpg",
	},
];

const customCharacters = [
	{
		name: "Malenia",
		source: "Elden Ring",
		img: "https://i.pinimg.com/564x/a4/06/13/a40613869260cb269d0335e265c79ba8.jpg",
	},
	{
		name: "Guts",
		source: "Berserk",
		img: "https://i.pinimg.com/564x/31/85/3e/31853e6601d51a66072b22650c822369.jpg",
	},
	{
		name: "2B",
		source: "Nier: Automata",
		img: "https://i.pinimg.com/564x/44/2c/62/442c628df529e0617300cf9d0411a0a2.jpg",
	},
	{
		name: "Lucy",
		source: "Edgerunners",
		img: "https://i.pinimg.com/736x/88/2c/3f/882c3f156d9539d04838618f03c02640.jpg",
	},
	{
		name: "Kratos",
		source: "God of War",
		img: "https://i.pinimg.com/564x/e1/90/18/e19018420937a0928230713be51878d6.jpg",
	},
];
---

<html lang="es" class="dark">
	<head>
		<meta charset="UTF-8" />
		<title>{profile.username} | Colección</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
		/>
		<style>
			/* FONDO ELEGANTE */
			body {
				background-color: #050505;
				color: #e4e4e7;
				/* Patrón de rejilla muy sutil */
				background-image:
					linear-gradient(
						rgba(255, 255, 255, 0.03) 1px,
						transparent 1px
					),
					linear-gradient(
						90deg,
						rgba(255, 255, 255, 0.03) 1px,
						transparent 1px
					);
				background-size: 40px 40px;
			}

			.glass {
				background: rgba(20, 20, 23, 0.7);
				backdrop-filter: blur(12px);
				border: 1px solid rgba(255, 255, 255, 0.05);
			}
			.hide-scroll::-webkit-scrollbar {
				display: none;
			}

			/* ACORDEÓN DE FAVORITOS */
			.accordion-item {
				flex: 1;
				transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
				filter: grayscale(0.6);
			}
			.accordion-item:hover {
				flex: 3;
				filter: grayscale(0);
				cursor: pointer;
			}
			.accordion-item img {
				object-position: center 20%;
			} /* Enfocar la parte superior de las covers */

			/* TEXTO VERTICAL */
			.vertical-text {
				writing-mode: vertical-rl;
				text-orientation: mixed;
				transform: rotate(180deg);
			}
		</style>
	</head>
	<body
		class="font-sans min-h-screen pb-20 selection:bg-indigo-500/30 selection:text-white"
	>
		<header class="relative w-full mb-16">
			<div class="h-80 w-full overflow-hidden relative">
				<img
					src={bannerPath}
					onerror="this.src='https://placehold.co/1500x500/111/333?text=Banner'"
					class="w-full h-full object-cover opacity-50 mask-image-gradient"
				/>
				<div
					class="absolute inset-0 bg-gradient-to-t from-[#050505] via-[#050505]/60 to-transparent"
				>
				</div>

				<a
					href="/admin"
					class="absolute top-6 right-6 glass px-4 py-2 rounded-full text-xs font-bold text-white hover:bg-white/10 transition border border-white/5 flex items-center gap-2 z-20"
				>
					<i class="fa-solid fa-gear"></i>
					<span>Setup</span>
				</a>
			</div>

			<div
				class="absolute -bottom-10 left-0 w-full px-6 md:px-12 flex flex-col md:flex-row items-end gap-6 z-10 max-w-7xl mx-auto"
			>
				<div class="relative group">
					<div
						class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full blur opacity-50 group-hover:opacity-100 transition duration-500"
					>
					</div>
					<img
						src={avatarPath}
						onerror="this.src='https://placehold.co/200?text=U'"
						class="relative w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-[#050505] object-cover bg-[#1a1a1e]"
					/>
				</div>
				<div class="mb-4 flex-1">
					<h1
						class="text-4xl md:text-5xl font-black text-white tracking-tighter"
					>
						{profile.username}
					</h1>
					<p
						class="text-gray-400 text-sm md:text-base font-medium flex items-center gap-2 mt-1"
					>
						<span
							class="w-2 h-2 bg-green-500 rounded-full animate-pulse"
						></span>
						{profile.bio}
					</p>
				</div>

				<div
					class="hidden md:flex gap-8 mb-6 bg-white/5 px-6 py-3 rounded-2xl border border-white/5 backdrop-blur-md"
				>
					<div class="text-center">
						<span class="block text-2xl font-bold text-white"
							>{allContent.length}</span
						>
						<span
							class="text-[10px] text-gray-500 uppercase font-bold"
							>Total</span
						>
					</div>
					<div class="text-center">
						<span class="block text-2xl font-bold text-indigo-400"
							>{
								allContent.filter(
									(i) => i.data.status === "Jugando",
								).length
							}</span
						>
						<span
							class="text-[10px] text-gray-500 uppercase font-bold"
							>Activos</span
						>
					</div>
					<div class="text-center">
						<span class="block text-2xl font-bold text-yellow-400"
							>{favorites.length}</span
						>
						<span
							class="text-[10px] text-gray-500 uppercase font-bold"
							>Favs</span
						>
					</div>
				</div>
			</div>
		</header>

		<main class="max-w-7xl mx-auto px-4 md:px-8 space-y-16">
			<section>
				<div class="flex items-center justify-between mb-6">
					<h2
						class="text-2xl font-bold text-white flex items-center gap-2"
					>
						<i class="fa-solid fa-crown text-yellow-500"></i> Hall of
						Fame
					</h2>
					<div
						class="bg-white/5 p-1 rounded-lg flex text-xs font-bold"
					>
						<button
							onclick="switchFav('works', this)"
							class="fav-tab active px-4 py-1.5 rounded-md bg-white text-black shadow-sm transition-all"
							>Obras</button
						>
						<button
							onclick="switchFav('chars', this)"
							class="fav-tab px-4 py-1.5 rounded-md text-gray-400 hover:text-white transition-all"
							>Personajes</button
						>
					</div>
				</div>

				<div
					id="fav-works"
					class="h-[400px] flex gap-1.5 w-full overflow-hidden rounded-2xl shadow-2xl ring-1 ring-white/10"
				>
					{
						favorites.map((item) => (
							<div class="accordion-item relative group overflow-hidden">
								<img
									src={item.data.cover}
									class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity"
								/>

								<div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent" />

								<div class="absolute bottom-6 left-6 opacity-0 group-hover:opacity-100 transition-all duration-500 transform translate-y-4 group-hover:translate-y-0 hidden md:block">
									<h3 class="text-2xl font-black text-white leading-none uppercase italic">
										{item.data.title}
									</h3>
									<div class="flex items-center gap-2 mt-2">
										<span class="bg-yellow-500 text-black text-xs font-bold px-2 py-0.5 rounded">
											{item.data.score}/10
										</span>
										<span class="text-gray-400 text-xs font-bold">
											{item.data.year}
										</span>
									</div>
								</div>

								<div class="absolute bottom-4 left-1/2 -translate-x-1/2 group-hover:opacity-0 transition-opacity duration-300 md:block hidden">
									<span class="vertical-text text-white/50 font-bold tracking-widest text-xs uppercase truncate max-h-[200px]">
										{item.data.title}
									</span>
								</div>
							</div>
						))
					}

					{
						favorites.length === 0 && (
							<div class="w-full flex items-center justify-center text-gray-500 bg-white/5">
								Sin favoritos aún
							</div>
						)
					}
				</div>

				<div
					id="fav-chars"
					class="hidden h-[400px] flex gap-1.5 w-full overflow-hidden rounded-2xl shadow-2xl ring-1 ring-white/10"
				>
					{
						customCharacters.map((char) => (
							<div class="accordion-item relative group overflow-hidden">
								<img
									src={char.img}
									class="w-full h-full object-cover object-top opacity-80 group-hover:opacity-100 transition-opacity"
								/>
								<div class="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-black/90" />

								<div class="absolute bottom-6 left-6 opacity-0 group-hover:opacity-100 transition-all duration-500 transform translate-y-4 group-hover:translate-y-0 hidden md:block">
									<h3 class="text-3xl font-black text-white leading-none uppercase">
										{char.name}
									</h3>
									<p class="text-indigo-400 text-sm font-bold mt-1">
										{char.source}
									</p>
								</div>
							</div>
						))
					}
				</div>
			</section>

			<section>
				<h2
					class="text-xl font-bold text-white mb-4 flex items-center gap-2 opacity-80"
				>
					<i class="fa-regular fa-calendar-check"></i> Favorito del Mes
				</h2>
				<div class="flex gap-4 overflow-x-auto hide-scroll pb-4">
					{
						monthlyPicks.map((pick) => (
							<div class="flex-shrink-0 group cursor-pointer">
								<div class="flex items-center gap-3 bg-[#121215] border border-white/5 pr-4 rounded-full hover:bg-white/5 transition-colors group-hover:border-indigo-500/30">
									<div class="w-14 h-14 rounded-full bg-[#1a1a1e] border border-white/5 flex flex-col items-center justify-center shrink-0 group-hover:scale-105 transition-transform">
										<span class="text-[10px] text-gray-500 font-bold leading-none">
											{pick.year}
										</span>
										<span class="text-xs text-white font-black leading-tight">
											{pick.month}
										</span>
									</div>

									<div class="flex items-center gap-3">
										<img
											src={pick.cover}
											class="w-8 h-10 rounded object-cover opacity-80 group-hover:opacity-100"
										/>
										<div>
											<h4 class="text-sm font-bold text-gray-200 group-hover:text-indigo-400 transition-colors">
												{pick.title}
											</h4>
											<p class="text-[10px] text-gray-600 uppercase font-bold tracking-wider">
												Top Pick
											</p>
										</div>
									</div>
								</div>
							</div>
						))
					}

					<div
						class="flex-shrink-0 flex items-center justify-center w-14 h-14 rounded-full border border-dashed border-gray-700 text-gray-700 hover:text-gray-500 hover:border-gray-500 transition cursor-pointer"
					>
						<i class="fa-solid fa-plus"></i>
					</div>
				</div>
			</section>

			<section>
				<div
					class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 border-t border-white/5 pt-8"
				>
					<h2 class="text-xl font-bold text-white opacity-80">
						Biblioteca Completa
					</h2>

					<nav class="flex gap-2 bg-black/20 p-1 rounded-xl w-fit">
						<button
							onclick="filter('all', this)"
							class="grid-tab active px-4 py-1.5 rounded-lg text-xs font-bold bg-white/10 text-white shadow-sm transition-all"
							>Todo</button
						>
						<button
							onclick="filter('game', this)"
							class="grid-tab px-4 py-1.5 rounded-lg text-xs font-bold text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all"
							>Juegos</button
						>
						<button
							onclick="filter('anime', this)"
							class="grid-tab px-4 py-1.5 rounded-lg text-xs font-bold text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all"
							>Anime</button
						>
						<button
							onclick="filter('manga', this)"
							class="grid-tab px-4 py-1.5 rounded-lg text-xs font-bold text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all"
							>Manga</button
						>
					</nav>
				</div>

				<div
					id="grid"
					class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-7 gap-4"
				>
					{
						allContent.map((item) => (
							<div
								class="relative aspect-[2/3] rounded-lg overflow-hidden cursor-pointer group bg-[#121215]"
								data-type={item.type}
							>
								<img
									src={item.data.cover}
									loading="lazy"
									class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 opacity-70 group-hover:opacity-100"
								/>

								<div
									class={`absolute top-2 right-2 w-2 h-2 rounded-full shadow-lg ${item.data.status === "Jugando" ? "bg-green-500 shadow-green-500/50" : item.data.status === "Completado" ? "bg-blue-500" : "bg-gray-500"}`}
								/>

								<div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-3">
									<div>
										<h3 class="text-white text-xs font-bold leading-tight line-clamp-2">
											{item.data.title}
										</h3>
										<div class="flex items-center gap-1 text-[10px] text-gray-400 mt-1">
											<i class="fa-solid fa-star text-yellow-600" />{" "}
											{item.data.score}
										</div>
									</div>
								</div>
							</div>
						))
					}
				</div>

				<div
					id="empty-state"
					class="hidden py-20 text-center text-gray-600"
				>
					No hay contenido aquí.
				</div>
			</section>
		</main>

		<script is:inline>
			// Lógica de Tabs de Favoritos
			function switchFav(type, btn) {
				document.querySelectorAll(".fav-tab").forEach((b) => {
					b.classList.remove("bg-white", "text-black");
					b.classList.add("text-gray-400");
				});
				btn.classList.add("bg-white", "text-black");
				btn.classList.remove("text-gray-400");

				if (type === "works") {
					document
						.getElementById("fav-works")
						.classList.remove("hidden");
					document
						.getElementById("fav-chars")
						.classList.add("hidden");
					document.getElementById("fav-works").classList.add("flex");
				} else {
					document
						.getElementById("fav-works")
						.classList.add("hidden");
					document
						.getElementById("fav-works")
						.classList.remove("flex");
					document
						.getElementById("fav-chars")
						.classList.remove("hidden");
				}
			}

			// Lógica de Filtro Grid
			function filter(cat, btn) {
				document.querySelectorAll(".grid-tab").forEach((b) => {
					b.className =
						"grid-tab px-4 py-1.5 rounded-lg text-xs font-bold text-gray-500 hover:text-gray-300 hover:bg-white/5 transition-all";
				});
				btn.className =
					"grid-tab active px-4 py-1.5 rounded-lg text-xs font-bold bg-white/10 text-white shadow-sm transition-all";

				const items = document.querySelectorAll("#grid > div");
				let count = 0;
				items.forEach((item) => {
					if (cat === "all" || item.dataset.type === cat) {
						item.style.display = "block";
						count++;
					} else {
						item.style.display = "none";
					}
				});
				document.getElementById("empty-state").style.display = count
					? "none"
					: "block";
			}
		</script>
	</body>
</html>
