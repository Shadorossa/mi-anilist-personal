---
import { getCollection } from "astro:content";

// 1. Cargar datos
let profile = {
	username: "Admin",
	bio: "Bienvenido a mi colección.",
	banner: "",
	avatar: "",
};
try {
	const config = await import("../content/config.json");
	profile = config.default || config;
} catch (e) {}

// Cargar colecciones (si no existen carpetas aun, devuelve array vacío)
const games = await getCollection("games").catch(() => []);
const anime = await getCollection("anime").catch(() => []);
const manga = await getCollection("manga").catch(() => []);

// Unificar todo y marcar el tipo
const allContent = [
	...games.map((i) => ({ ...i, type: "game" })),
	...anime.map((i) => ({ ...i, type: "anime" })),
	...manga.map((i) => ({ ...i, type: "manga" })),
];

// Favoritos (Obras con nota 10 o 9)
const favorites = allContent.filter((i) => i.data.score >= 9);
---

<html lang="es" class="dark">
	<head>
		<meta charset="UTF-8" />
		<title>{profile.username} | Biblioteca</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
		/>
		<style>
			/* Efecto Glassmorphism */
			.glass {
				background: rgba(30, 30, 35, 0.7);
				backdrop-filter: blur(10px);
				border: 1px solid rgba(255, 255, 255, 0.1);
			}
			/* Ocultar scrollbar pero permitir scroll */
			.hide-scroll::-webkit-scrollbar {
				display: none;
			}
			.hide-scroll {
				-ms-overflow-style: none;
				scrollbar-width: none;
			}
		</style>
	</head>
	<body class="bg-[#0f0f12] text-gray-200 font-sans min-h-screen">
		<header class="relative w-full">
			<div
				class="h-64 md:h-80 w-full bg-gray-800 overflow-hidden relative"
			>
				<img
					src={profile.banner ||
						"https://images.unsplash.com/photo-1550745165-9bc0b252726f?auto=format&fit=crop&w=2000&q=80"}
					class="w-full h-full object-cover opacity-80"
					alt="banner"
				/>
				<div
					class="absolute inset-0 bg-gradient-to-t from-[#0f0f12] to-transparent"
				>
				</div>

				<a
					href="/admin"
					class="absolute top-4 right-4 bg-black/50 hover:bg-white/20 text-white px-3 py-1 rounded-full text-xs backdrop-blur-md transition"
				>
					<i class="fa-solid fa-gear"></i> Admin
				</a>
			</div>

			<div
				class="absolute -bottom-16 left-0 right-0 flex flex-col items-center px-4"
			>
				<div class="relative group">
					<img
						src={profile.avatar ||
							"https://api.dicebear.com/7.x/avataaars/svg?seed=Felix"}
						class="w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-[#0f0f12] shadow-2xl object-cover bg-gray-700"
					/>
					<div
						class="absolute bottom-2 right-2 bg-green-500 w-4 h-4 rounded-full border-2 border-[#0f0f12]"
						title="Online"
					>
					</div>
				</div>

				<div class="text-center mt-4">
					<h1 class="text-3xl font-bold text-white tracking-tight">
						{profile.username}
					</h1>
					<p
						class="text-gray-400 max-w-md mx-auto mt-1 text-sm md:text-base"
					>
						{profile.bio}
					</p>
				</div>
			</div>
		</header>

		<main class="mt-24 px-4 md:px-8 max-w-7xl mx-auto pb-20">
			<nav
				class="flex justify-center gap-2 md:gap-6 mb-10 overflow-x-auto hide-scroll py-2"
			>
				<button
					onclick="filter('all')"
					class="tab-btn active px-6 py-2 rounded-full font-medium transition-all duration-300 flex items-center gap-2 text-white bg-white/10 hover:bg-white/20 ring-1 ring-white/10"
				>
					<i class="fa-solid fa-layer-group"></i> Todo
				</button>
				<button
					onclick="filter('fav')"
					class="tab-btn px-6 py-2 rounded-full font-medium transition-all duration-300 flex items-center gap-2 text-gray-400 hover:text-white hover:bg-white/5"
				>
					<i class="fa-solid fa-heart text-red-500"></i> Favoritos
				</button>
				<button
					onclick="filter('game')"
					class="tab-btn px-6 py-2 rounded-full font-medium transition-all duration-300 flex items-center gap-2 text-gray-400 hover:text-white hover:bg-white/5"
				>
					<i class="fa-solid fa-gamepad text-purple-400"></i> Juegos
				</button>
				<button
					onclick="filter('anime')"
					class="tab-btn px-6 py-2 rounded-full font-medium transition-all duration-300 flex items-center gap-2 text-gray-400 hover:text-white hover:bg-white/5"
				>
					<i class="fa-solid fa-tv text-pink-400"></i> Anime
				</button>
				<button
					onclick="filter('manga')"
					class="tab-btn px-6 py-2 rounded-full font-medium transition-all duration-300 flex items-center gap-2 text-gray-400 hover:text-white hover:bg-white/5"
				>
					<i class="fa-solid fa-book-open text-orange-400"></i> Manga
				</button>
			</nav>

			<div
				id="grid"
				class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6"
			>
				{
					allContent.map((item) => (
						<div
							class="media-card group relative aspect-[2/3] rounded-xl overflow-hidden cursor-pointer shadow-lg bg-gray-800 transition-transform duration-300 hover:-translate-y-2 hover:shadow-2xl hover:shadow-purple-500/20"
							data-type={item.type}
							data-fav={item.data.score >= 9 ? "true" : "false"}
						>
							<img
								src={item.data.cover}
								alt={item.data.title}
								class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
								loading="lazy"
							/>

							<div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent opacity-60 group-hover:opacity-80 transition-opacity" />

							<div class="absolute top-2 right-2 glass px-2 py-1 rounded-md text-xs font-bold text-white flex items-center gap-1">
								<i class="fa-solid fa-star text-yellow-400 text-[10px]" />{" "}
								{item.data.score}
							</div>

							<div class="absolute bottom-0 left-0 right-0 p-3 transform translate-y-2 group-hover:translate-y-0 transition-transform duration-300">
								<div class="text-[10px] uppercase tracking-wider text-gray-400 mb-1 flex items-center gap-2">
									<span
										class={`w-2 h-2 rounded-full ${
											item.data.status === "Jugando" ||
											item.data.status === "Viendo"
												? "bg-green-500 animate-pulse"
												: item.data.status ===
													  "Completado"
													? "bg-blue-500"
													: item.data.status ===
														  "Abandonado"
														? "bg-red-500"
														: "bg-yellow-500"
										}`}
									/>
									{item.data.status}
								</div>
								<h3 class="text-white font-bold leading-tight text-sm md:text-base line-clamp-2">
									{item.data.title}
								</h3>
							</div>
						</div>
					))
				}

				<div
					id="empty-state"
					class="hidden col-span-full text-center py-20 text-gray-500"
				>
					<i class="fa-regular fa-folder-open text-4xl mb-4"></i>
					<p>No hay contenido en esta categoría.</p>
				</div>
			</div>
		</main>

		<script is:inline>
			function filter(category) {
				// Actualizar botones
				document.querySelectorAll(".tab-btn").forEach((btn) => {
					btn.className =
						"tab-btn px-6 py-2 rounded-full font-medium transition-all duration-300 flex items-center gap-2 text-gray-400 hover:text-white hover:bg-white/5";
				});
				event.currentTarget.className =
					"tab-btn active px-6 py-2 rounded-full font-medium transition-all duration-300 flex items-center gap-2 text-white bg-white/10 hover:bg-white/20 ring-1 ring-white/10 shadow-lg shadow-purple-500/10";

				// Filtrar cards
				const cards = document.querySelectorAll(".media-card");
				let visibleCount = 0;

				cards.forEach((card) => {
					const type = card.getAttribute("data-type");
					const isFav = card.getAttribute("data-fav") === "true";

					if (
						category === "all" ||
						type === category ||
						(category === "fav" && isFav)
					) {
						card.style.display = "block";
						// Pequeña animación de entrada
						card.animate(
							[
								{ transform: "scale(0.95)", opacity: 0 },
								{ transform: "scale(1)", opacity: 1 },
							],
							{ duration: 300, easing: "ease-out" },
						);
						visibleCount++;
					} else {
						card.style.display = "none";
					}
				});

				// Mostrar empty state si no hay nada
				const empty = document.getElementById("empty-state");
				empty.style.display = visibleCount === 0 ? "block" : "none";
			}
		</script>
	</body>
</html>
