---
import { getCollection } from "astro:content";

// 1. Cargar Configuración del Perfil
let profile = { username: "Admin", bio: "Cargando perfil..." };
try {
	const config = await import("../content/config.json");
	profile = config.default || config;
} catch (e) {}

// Definir rutas de imágenes (Busca en /public/img/profile/)
const bannerPath = "/img/profile/banner.png";
const avatarPath = "/img/profile/pic.png";

// 2. Cargar Colecciones
const games = await getCollection("games").catch(() => []);
const anime = await getCollection("anime").catch(() => []);
const manga = await getCollection("manga").catch(() => []);

// 3. Unificar todo
const allContent = [
	...games.map((i) => ({ ...i, type: "game" })),
	...anime.map((i) => ({ ...i, type: "anime" })),
	...manga.map((i) => ({ ...i, type: "manga" })),
];

// Ordenar por nota (Mayor a menor)
allContent.sort((a, b) => b.data.score - a.data.score);
---

<html lang="es" class="dark">
	<head>
		<meta charset="UTF-8" />
		<title>{profile.username} | Biblioteca</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
		/>
		<style>
			/* Estilos Base */
			body {
				background-color: #09090b;
				color: #e4e4e7;
			}
			.glass {
				background: rgba(20, 20, 25, 0.7);
				backdrop-filter: blur(12px);
				border: 1px solid rgba(255, 255, 255, 0.05);
			}
			.hide-scroll::-webkit-scrollbar {
				display: none;
			}

			/* Animaciones */
			@keyframes fadeInUp {
				from {
					opacity: 0;
					transform: translateY(20px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}
			.card-enter {
				animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1)
					backwards;
			}
		</style>
	</head>
	<body
		class="font-sans min-h-screen selection:bg-indigo-500 selection:text-white"
	>
		<header class="relative w-full group">
			<div class="h-64 md:h-80 w-full overflow-hidden relative">
				<img
					src={bannerPath}
					onerror="this.src='https://placehold.co/1500x500/111/444?text=No+Banner'"
					class="w-full h-full object-cover opacity-60 transition-transform duration-[10s] group-hover:scale-105"
				/>
				<div
					class="absolute inset-0 bg-gradient-to-t from-[#09090b] via-[#09090b]/40 to-transparent"
				>
				</div>

				<a
					href="/admin"
					class="absolute top-6 right-6 glass px-4 py-2 rounded-full text-xs font-bold hover:bg-white/10 transition border border-white/5 flex items-center gap-2"
				>
					<i class="fa-solid fa-sliders"></i> Gestionar
				</a>
			</div>

			<div
				class="absolute -bottom-16 left-0 right-0 flex flex-col items-center z-10"
			>
				<div class="relative group cursor-pointer">
					<img
						src={avatarPath}
						onerror="this.src='https://placehold.co/200/222/FFF?text=User'"
						class="w-32 h-32 md:w-40 md:h-40 rounded-full border-[6px] border-[#09090b] shadow-2xl object-cover bg-[#1a1a1e] transition-transform hover:scale-105"
					/>
				</div>
				<div class="text-center mt-3 animate-fade-in">
					<h1
						class="text-3xl font-bold text-white tracking-tight drop-shadow-lg"
					>
						{profile.username}
					</h1>
					<p class="text-gray-400 text-sm mt-1">{profile.bio}</p>
				</div>
			</div>
		</header>

		<main class="mt-24 px-4 max-w-7xl mx-auto pb-20">
			<nav
				class="flex justify-center gap-3 mb-12 overflow-x-auto hide-scroll py-2"
			>
				<button
					onclick="filter('all', this)"
					class="tab-btn active px-6 py-2 rounded-full text-sm font-bold bg-white text-black shadow-lg shadow-white/10 transition-transform active:scale-95"
					>Todo</button
				>
				<button
					onclick="filter('fav', this)"
					class="tab-btn px-6 py-2 rounded-full text-sm font-bold bg-[#18181b] text-gray-400 hover:text-white border border-white/5 transition-colors"
					>Favoritos</button
				>
				<button
					onclick="filter('game', this)"
					class="tab-btn px-6 py-2 rounded-full text-sm font-bold bg-[#18181b] text-gray-400 hover:text-white border border-white/5 transition-colors"
					>Juegos</button
				>
				<button
					onclick="filter('anime', this)"
					class="tab-btn px-6 py-2 rounded-full text-sm font-bold bg-[#18181b] text-gray-400 hover:text-white border border-white/5 transition-colors"
					>Anime</button
				>
				<button
					onclick="filter('manga', this)"
					class="tab-btn px-6 py-2 rounded-full text-sm font-bold bg-[#18181b] text-gray-400 hover:text-white border border-white/5 transition-colors"
					>Manga</button
				>
			</nav>

			<div
				id="grid"
				class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-5"
			>
				{
					allContent.map((item, index) => (
						<div
							class="card-enter group relative aspect-[2/3] rounded-xl overflow-hidden cursor-pointer bg-[#18181b] shadow-lg ring-1 ring-white/5 transition-all duration-500 hover:-translate-y-2 hover:shadow-2xl hover:shadow-indigo-500/20"
							style={`animation-delay: ${index * 40}ms`}
							data-type={item.type}
							data-fav={item.data.score >= 9 ? "true" : "false"}
						>
							<img
								src={item.data.cover}
								loading="lazy"
								class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
							/>

							<div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent opacity-60 group-hover:opacity-80 transition-opacity" />

							<div class="absolute top-2 right-2 glass px-2 py-1 rounded-md text-xs font-bold text-white flex items-center gap-1 shadow-lg">
								<i class="fa-solid fa-star text-yellow-400 text-[10px]" />{" "}
								{item.data.score}
							</div>

							<div class="absolute bottom-0 left-0 right-0 p-4 transform translate-y-2 group-hover:translate-y-0 transition-transform duration-300">
								<div class="text-[10px] uppercase font-bold text-gray-400 mb-1 flex items-center gap-2">
									<span
										class={`w-2 h-2 rounded-full ${item.data.status === "Jugando" ? "bg-green-500 animate-pulse" : item.data.status === "Completado" ? "bg-blue-500" : "bg-yellow-500"}`}
									/>
									{item.data.status}
								</div>
								<h3 class="text-white font-bold text-sm leading-tight line-clamp-2 group-hover:text-indigo-300 transition-colors">
									{item.data.title}
								</h3>
							</div>
						</div>
					))
				}
			</div>

			<div
				id="empty-state"
				class="hidden text-center py-20 text-gray-600"
			>
				<i class="fa-regular fa-folder-open text-4xl mb-4 opacity-50"
				></i>
				<p>Sin contenido.</p>
			</div>
		</main>

		<script is:inline>
			function filter(cat, btn) {
				document
					.querySelectorAll(".tab-btn")
					.forEach(
						(b) =>
							(b.className =
								"tab-btn px-6 py-2 rounded-full text-sm font-bold bg-[#18181b] text-gray-400 hover:text-white border border-white/5 transition-colors"),
					);
				btn.className =
					"tab-btn active px-6 py-2 rounded-full text-sm font-bold bg-white text-black shadow-lg shadow-white/10 transition-transform active:scale-95";

				const cards = document.querySelectorAll("[data-type]");
				let visible = 0;
				cards.forEach((c) => {
					const match =
						cat === "all" ||
						c.dataset.type === cat ||
						(cat === "fav" && c.dataset.fav === "true");
					c.style.display = match ? "block" : "none";
					if (match) visible++;
				});
				document.getElementById("empty-state").style.display = visible
					? "none"
					: "block";
			}
		</script>
	</body>
</html>
